<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MAFS HRMS â€” Updated Attendance Rules</title>
<style>
:root{
  --bg:#f5f8fb; --panel:#ffffff; --muted:#6b7280; --accent:#4f46e5; --accent-2:#22c1c3;
  --text:#0b1220; --glass: rgba(11,18,32,0.04); --shadow: 0 10px 30px rgba(11,18,32,0.06);
  --radius:12px;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef5fb);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;min-height:100vh;align-items:stretch}
.sidebar{width:300px;padding:26px;background:linear-gradient(180deg,#fff,#f3fbff);border-right:1px solid var(--glass);display:flex;flex-direction:column;gap:18px;box-shadow:var(--shadow)}
.brand{display:flex;align-items:center;gap:12px;font-weight:800;color:var(--accent);font-size:18px}
.brand .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:18px}
.side-search input{width:100%;padding:10px;border-radius:999px;border:1px solid rgba(11,18,32,0.06);background:transparent;color:var(--muted)}
.nav-group{margin-top:6px}
.nav-title{font-weight:700;color:var(--muted);font-size:12px;margin:10px 6px}
.nav-list{display:flex;flex-direction:column;gap:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:none;background:transparent;cursor:pointer;color:var(--muted)}
.nav-item .icon{width:36px;height:36px;border-radius:8px;background:rgba(11,18,32,0.03);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}
.nav-item .label{font-weight:600}
.nav-item:hover{color:var(--text);background:linear-gradient(90deg, rgba(79,70,229,0.06), rgba(34,193,195,0.03))}
.nav-item.active{background:linear-gradient(90deg, rgba(79,70,229,0.14), rgba(34,193,195,0.06));color:var(--text);box-shadow:0 8px 24px rgba(79,70,229,0.04)}
.submenu{margin-left:48px;display:flex;flex-direction:column;gap:6px;margin-top:6px}
.submenu .sub{padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
.submenu .sub:hover{background:rgba(79,70,229,0.04);color:var(--text)}
.user-area{margin-top:auto;display:flex;align-items:center;gap:12px;padding-top:10px;border-top:1px solid rgba(11,18,32,0.03)}
.user-area .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,#fff,#f0f4f8);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--text)}
.user-area .meta{font-size:13px;color:var(--muted)}
.signout-btn{border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:12px}
.main{flex:1;padding:28px;display:flex;flex-direction:column;gap:18px}
.topbar{display:flex;justify-content:space-between;align-items:center}
.searchbar{display:flex;gap:12px;align-items:center}
.searchbar input{padding:10px;border-radius:10px;border:1px solid rgba(11,18,32,0.06);width:320px}
.columns{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
.card{background:var(--panel);border-radius:var(--radius);padding:16px;border:1px solid rgba(11,18,32,0.03);box-shadow:var(--shadow)}
.tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.tile{padding:14px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid rgba(11,18,32,0.03)}
.tile .label{font-size:12px;color:var(--muted)}
.tile .value{font-weight:800;font-size:26px;margin-top:6px}
.landscape{display:flex;gap:18px;border-radius:12px;overflow:hidden;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
.landscape .left{padding:18px;flex:0 0 420px;display:flex;flex-direction:column;gap:10px}
.landscape .left .avatar{width:84px;height:84px;border-radius:12px;background:white;color:#0b1220;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px}
.landscape .right{background:#fff;color:var(--text);padding:18px;flex:1;display:flex;flex-direction:column;gap:12px}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.stat{background:#fbfdff;padding:10px;border-radius:10px;border:1px solid rgba(11,18,32,0.03)}
.table{width:100%;border-collapse:collapse}
.table th{font-size:13px;color:var(--muted);text-align:left;padding:8px}
.table td{padding:10px;border-top:1px solid rgba(11,18,32,0.04)}
.form-row{display:flex;gap:8px}
.input{padding:10px;border-radius:8px;border:1px solid rgba(11,18,32,0.06);width:100%}
.btn{padding:9px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);color:var(--muted)}
.tiny{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:24px;top:24px;min-width:280px;padding:12px;border-radius:10px;border:1px solid rgba(11,18,32,0.06);background:linear-gradient(180deg,#ffffff,#f8fdff);box-shadow:0 8px 20px rgba(11,18,32,0.08);z-index:9999}
.toast.success{border-left:6px solid var(--accent-2)}
.toast.warn{border-left:6px solid #f59e0b}
@media(max-width:1100px){ .sidebar{display:none} .columns{grid-template-columns:1fr} }
</style>
<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, query, where, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC21spMSCxJiFujIhAws1o8Uj4tKj8oD7Q",
    authDomain: "hrms-new-36aec.firebaseapp.com",
    projectId: "hrms-new-36aec",
    storageBucket: "hrms-new-36aec.firebasestorage.app",
    messagingSenderId: "174602894316",
    appId: "1:174602894316:web:e4f744e0d4280ea6ea1ec9",
    measurementId: "G-LZNCY029F9"
  };

  // Initialize Firebase
  const firebaseApp = initializeApp(firebaseConfig);
  const analytics = getAnalytics(firebaseApp);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);

  // Make Firebase services available globally
  window.firebaseApp = firebaseApp;
  window.firebaseAnalytics = analytics;
  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.firebaseAuthFunctions = { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged };
  window.firebaseFirestoreFunctions = { collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, query, where, orderBy, onSnapshot, Timestamp };
</script>
</head>
<body>

<!-- LOGIN / FIRST RUN (create SuperAdmin) -->
<div id="loginWrap" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(11,18,32,0.06);z-index:999">
  <div style="width:520px;background:var(--panel);border-radius:12px;padding:22px;box-shadow:var(--shadow)">
    <h2 style="margin:0 0 10px 0">MAFS HRMS â€” Sign in</h2>
    <div class="tiny" style="margin-bottom:12px;color:var(--muted)">Sign in as <strong>Employee</strong>, <strong>Admin</strong>, or <strong>Super-Admin</strong></div>
    <div id="firstRunNote" class="tiny" style="display:none;margin-bottom:10px;padding:8px;background:rgba(79,70,229,0.1);border-radius:6px;color:var(--accent)"><strong>First-time Setup:</strong> Create the first Super-Admin account. After this, you can create employee and admin accounts from the dashboard.</div>
    <div style="display:grid;gap:8px">
      <input id="loginUser" placeholder="Employee ID (e.g. EMP0001)" class="input"/>
      <input id="loginPass" type="password" placeholder="Password" class="input"/>
      <div style="display:flex;gap:8px">
        <button id="loginBtn" class="btn primary">Sign in</button>
        <button id="createSuperBtn" class="btn ghost" style="display:none">Create Super-Admin</button>
      </div>
      <div id="loginMsg" class="tiny" style="color:#c0392b"></div>
      <div class="tiny" style="margin-top:8px;color:var(--muted)">Don't have credentials? Contact your administrator. They will create your account and provide login details.</div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">
  <aside class="sidebar">
    <div class="brand"><div class="logo">M</div> MAFS HRMS</div>
    <div class="side-search"><input id="sideSearch" placeholder="Search employees..." /></div>

    <div class="nav-group"><div class="nav-title">MAIN</div><div class="nav-list" id="navMain"></div></div>
    <div class="nav-group"><div class="nav-title">EMPLOYEE</div><div class="nav-list" id="navEmp"></div></div>
    <div class="nav-group"><div class="nav-title">ADMIN</div><div class="nav-list" id="navAdmin"></div></div>

    <div class="user-area">
      <div class="avatar" id="userAvatar">S</div>
      <div><div id="userName" style="font-weight:700">â€”</div><div class="tiny" id="userRole">â€”</div></div>
      <div style="margin-left:auto"><button id="sideSignOut" class="signout-btn">Sign out</button></div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div><h3 id="pageTitle" style="margin:0">Dashboard</h3><div id="pageSubtitle" class="tiny">Overview</div></div>
      <div class="searchbar"><input id="globalSearch" placeholder="Quick search employees..." /><button id="exportAll" class="btn ghost">Export</button></div>
    </div>

    <div class="columns">
      <div><div id="mainContent"></div></div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Recent Activity</strong><div class="tiny">Attendance & leaves</div></div>
            <div><button id="exportCSVs" class="btn ghost">Export CSVs</button></div>
          </div>
          <div style="height:12px"></div>
          <div id="recentWrap" style="display:flex;gap:12px;overflow-x:auto;padding-bottom:8px"></div>
        </div>

        <div style="height:12px"></div>

        <div class="card"><strong>Announcements</strong><div id="annText" class="tiny" style="margin-top:10px">No announcements</div></div>
      </div>
    </div>
  </main>
</div>

<!-- Toast root -->
<div id="toastRoot" aria-live="polite" style="position:fixed;right:20px;top:20px;z-index:9999"></div>

<script>
/* HRMS with Firebase Authentication + Firestore
   - Login using Employee ID + Password
   - All data stored in Firestore
   - Real-time updates
   - Clock-in/Clock-out with timer
   - Auto Employee ID generation
*/

// Wait for Firebase to load
let firebaseDb, firebaseAuth, col, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, query, where, orderBy, onSnapshot, Timestamp;
let signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged;

// Initialize Firebase references after module loads
setTimeout(() => {
  firebaseDb = window.firebaseDb;
  firebaseAuth = window.firebaseAuth;
  const fsf = window.firebaseFirestoreFunctions;
  const af = window.firebaseAuthFunctions;
  col = fsf.collection; doc = fsf.doc; getDoc = fsf.getDoc; getDocs = fsf.getDocs;
  setDoc = fsf.setDoc; updateDoc = fsf.updateDoc; deleteDoc = fsf.deleteDoc; addDoc = fsf.addDoc;
  query = fsf.query; where = fsf.where; orderBy = fsf.orderBy; onSnapshot = fsf.onSnapshot; Timestamp = fsf.Timestamp;
  signInWithEmailAndPassword = af.signInWithEmailAndPassword; createUserWithEmailAndPassword = af.createUserWithEmailAndPassword;
  signOut = af.signOut; onAuthStateChanged = af.onAuthStateChanged;
  
  // Initialize auth state listener
  onAuthStateChanged(firebaseAuth, async (user) => {
    if(user){
      await loadUserData(user);
    } else {
      APP.currentUser = null;
    }
  });
  
  // Initialize data load
  if(!APP.currentUser) init();
}, 500);

// Firestore Data Layer
let DATA = { employees: [], attendance: {}, leaves: [], payslips: [], settings: { companyName: 'MAFS Studio', currency: 'â‚¹' }, announcements: '', notifications: [] };
let APP = { currentUser: null, employeeData: null, currentTimer: null, timerInterval: null };

// Load user data from Firestore after auth
async function loadUserData(firebaseUser){
  try {
    const userDoc = await getDoc(doc(firebaseDb, 'users', firebaseUser.uid));
    if(userDoc.exists()){
      const userData = userDoc.data();
      const empDoc = await getDoc(doc(firebaseDb, 'employees', userData.employeeID));
      APP.currentUser = { uid: firebaseUser.uid, email: firebaseUser.email, ...userData };
      APP.employeeData = empDoc.exists() ? { id: empDoc.id, ...empDoc.data() } : null;
      if(APP.currentUser.role !== 'superadmin' && APP.currentUser.role !== 'admin') afterLogin();
    }
  } catch(e){ console.error('Load user error:', e); }
}

// Firestore Helper Functions
async function getEmployees(){ try{ const snap = await getDocs(col(firebaseDb, 'employees')); return snap.docs.map(d => ({ id: d.id, ...d.data() })); } catch(e){ console.error(e); return []; } }
async function saveEmployee(empData, empId = null){ try{ if(empId) await setDoc(doc(firebaseDb, 'employees', empId), empData, { merge: true }); else{ const newDoc = await addDoc(col(firebaseDb, 'employees'), empData); return newDoc.id; } return empId; } catch(e){ console.error(e); alert('Error saving employee'); } }
async function deleteEmployee(empId){ try{ await deleteDoc(doc(firebaseDb, 'employees', empId)); } catch(e){ console.error(e); alert('Error deleting employee'); } }
async function getAttendance(employeeID, date){ try{ const attDoc = await getDoc(doc(firebaseDb, 'attendance', `${employeeID}_${date}`)); return attDoc.exists() ? { id: attDoc.id, ...attDoc.data() } : null; } catch(e){ console.error(e); return null; } }
async function saveAttendance(employeeID, date, attData){ try{ await setDoc(doc(firebaseDb, 'attendance', `${employeeID}_${date}`), attData, { merge: true }); } catch(e){ console.error(e); alert('Error saving attendance'); } }
async function getAllAttendanceToday(){ try{ const today = todayKey(); const q = query(col(firebaseDb, 'attendance'), where('date', '==', today)); const snap = await getDocs(q); return snap.docs.map(d => ({ id: d.id, ...d.data() })); } catch(e){ console.error(e); return []; } }
async function getLeaves(status = null){ try{ let q = col(firebaseDb, 'leaves'); if(status) q = query(q, where('status', '==', status)); const snap = await getDocs(q); return snap.docs.map(d => ({ id: d.id, ...d.data() })); } catch(e){ console.error(e); return []; } }
async function saveLeave(leaveData, leaveId = null){ try{ if(leaveId) await updateDoc(doc(firebaseDb, 'leaves', leaveId), leaveData); else{ const newDoc = await addDoc(col(firebaseDb, 'leaves'), leaveData); return newDoc.id; } return leaveId; } catch(e){ console.error(e); alert('Error saving leave'); } }
async function getSettings(){ try{ const setDoc = await getDoc(doc(firebaseDb, 'settings', 'main')); return setDoc.exists() ? setDoc.data() : { companyName: 'MAFS Studio', currency: 'â‚¹' }; } catch(e){ return { companyName: 'MAFS Studio', currency: 'â‚¹' }; } }
async function saveSettings(settings){ try{ await setDoc(doc(firebaseDb, 'settings', 'main'), settings, { merge: true }); } catch(e){ console.error(e); } }
async function generateEmployeeID(){ try{ const employees = await getEmployees(); const maxId = employees.reduce((max, e) => { const num = parseInt(e.employeeID?.replace('EMP', '') || '0'); return num > max ? num : max; }, 0); return `EMP${String(maxId + 1).padStart(4, '0')}`; } catch(e){ return `EMP${String(Date.now()).slice(-4)}`; } }

// Setup real-time listeners
function setupListeners(){
  // Settings listener
  onSnapshot(doc(firebaseDb, 'settings', 'main'), (snap) => { if(snap.exists()) DATA.settings = snap.data(); });
  
  // Employees listener
  onSnapshot(col(firebaseDb, 'employees'), async (snap) => { DATA.employees = snap.docs.map(d => ({ id: d.id, ...d.data() })); if(currentView === 'employeeManagement') await renderEmployeeTable(document.querySelector('.card'), ''); });
  
  // Leaves listener
  onSnapshot(col(firebaseDb, 'leaves'), (snap) => { DATA.leaves = snap.docs.map(d => ({ id: d.id, ...d.data() })); refreshRecent(); });
}

async function hashSHA256(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* DOM refs */
const loginWrap = document.getElementById('loginWrap'), firstRunNote = document.getElementById('firstRunNote'), createSuperBtn = document.getElementById('createSuperBtn'), loginBtn = document.getElementById('loginBtn'), loginUser = document.getElementById('loginUser'), loginPass = document.getElementById('loginPass'), loginMsg = document.getElementById('loginMsg');
const app = document.getElementById('app'), navMain = document.getElementById('navMain'), navEmp = document.getElementById('navEmp'), navAdmin = document.getElementById('navAdmin'), userAvatar = document.getElementById('userAvatar'), userName = document.getElementById('userName'), userRole = document.getElementById('userRole'), sideSignOut = document.getElementById('sideSignOut');
const mainContent = document.getElementById('mainContent'), pageTitle = document.getElementById('pageTitle'), pageSubtitle = document.getElementById('pageSubtitle');
const recentWrap = document.getElementById('recentWrap'), annText = document.getElementById('annText'), toastRoot = document.getElementById('toastRoot');
const exportCSVs = document.getElementById('exportCSVs'), exportAll = document.getElementById('exportAll');

/* notifications */
function pushNotification({title,message,level='info',targetRoles=['superadmin','admin','hr']}){ const n = {id:'n_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),title,message,level,targetRoles,ts:new Date().toISOString()}; DATA.notifications.push(n); if(matchesCurrentUserRole(n.targetRoles)) showToast(n); }
function showToast(n){ const el = document.createElement('div'); el.className='toast' + (n.level==='success' ? ' success' : n.level==='warn' ? ' warn' : ''); el.innerHTML = `<div style="font-weight:700">${n.title}</div><div class="tiny" style="margin-top:8px;color:var(--muted)">${n.message}</div>`; toastRoot.appendChild(el); setTimeout(()=>{ el.style.transition='opacity 300ms'; el.style.opacity=0; setTimeout(()=>el.remove(),350); },5000); }
function matchesCurrentUserRole(targetRoles){ if(!APP.currentUser) return false; return targetRoles.indexOf(APP.currentUser.role) !== -1 || targetRoles.indexOf('all') !== -1; }

/* Login with Employee ID + Password using Firebase Auth */
async function init(){
  try {
    // Check if superadmin exists
    const adminQ = query(col(firebaseDb, 'users'), where('role', '==', 'superadmin'));
    const adminSnap = await getDocs(adminQ);
    
    if(adminSnap.empty){
      firstRunNote.style.display = 'block';
      createSuperBtn.style.display = 'inline-block';
      loginBtn.style.display = 'none';
      
      createSuperBtn.onclick = async () => {
        const empId = loginUser.value.trim();
        const password = loginPass.value;
        if(!empId || !password){ loginMsg.textContent='Enter Employee ID & password'; return; }
        
        try {
          // Create superadmin in Firestore users collection
          const userCred = await createUserWithEmailAndPassword(firebaseAuth, `${empId}@hrms.local`, password);
          await setDoc(doc(firebaseDb, 'users', userCred.user.uid), {
            employeeID: empId,
            role: 'superadmin',
            displayName: 'Super Admin',
            createdAt: Timestamp.now()
          });
          loginMsg.style.color='green';
          loginMsg.textContent='Super-Admin created. Sign in.';
          createSuperBtn.style.display='none';
          loginBtn.style.display='inline-block';
          firstRunNote.style.display='none';
        } catch(e){ loginMsg.textContent = e.code === 'auth/email-already-in-use' ? 'Employee ID already exists' : e.message; }
      };
    } else {
      firstRunNote.style.display='none';
      createSuperBtn.style.display='none';
      loginBtn.style.display='inline-block';
    }
    
    loginBtn.onclick = async () => {
      loginMsg.textContent='';
      const empId = loginUser.value.trim();
      const password = loginPass.value;
      if(!empId || !password){ loginMsg.textContent='Enter Employee ID & password'; return; }
      
      try {
        // Find user by Employee ID
        const userQ = query(col(firebaseDb, 'users'), where('employeeID', '==', empId));
        const userSnap = await getDocs(userQ);
        
        if(userSnap.empty){ loginMsg.textContent='Invalid Employee ID'; return; }
        
        const userData = userSnap.docs[0].data();
        // Login with Firebase Auth (email format: employeeID@hrms.local)
        await signInWithEmailAndPassword(firebaseAuth, `${empId}@hrms.local`, password);
        // loadUserData will be called by onAuthStateChanged
      } catch(e){
        if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') loginMsg.textContent='Invalid Employee ID or password';
        else loginMsg.textContent = e.message;
      }
    };
    
    // Load settings and employees
    DATA.settings = await getSettings();
    DATA.employees = await getEmployees();
    DATA.leaves = await getLeaves();
    setupListeners();
  } catch(e){ console.error('Init error:', e); loginMsg.textContent='Error initializing. Please refresh.'; }
}

let currentView = null;
async function afterLogin(){
  loginWrap.style.display='none';
  app.style.display='flex';
  userAvatar.textContent = (APP.currentUser.displayName || APP.employeeData?.name || 'U').slice(0,1).toUpperCase();
  userName.textContent = APP.currentUser.displayName || APP.employeeData?.name || 'User';
  userRole.textContent = APP.currentUser.role || 'employee';
  buildSidebar();
  // Load data
  DATA.settings = await getSettings();
  DATA.employees = await getEmployees();
  DATA.leaves = await getLeaves();
  if(APP.currentUser.role === 'employee') await renderEmployeeHome();
  else await renderAdminDashboard();
}

/* Sidebar builders (same pattern) */
function clearSidebar(){ navMain.innerHTML=''; navEmp.innerHTML=''; navAdmin.innerHTML=''; }
function buildSidebar(){ clearSidebar(); addNavMain('Dashboard','D', ()=>{ if(isEmployee()) renderEmployeeHome(); else renderAdminDashboard(); }, true); if(!isEmployee()){ addNavAdminItem('Employee Management','E', ()=>renderEmployeeManagement()); addNavAdminItem('Attendance & Leave','A', ()=>renderAttendanceManagement()); addNavAdminItem('Payroll','$', ()=>renderPayroll()); addNavAdminItem('Reports','R', ()=>renderReports()); addNavAdminItem('Settings','S', ()=>renderSettings()); } if(isEmployee()){ addNavEmpItem('Home','ðŸ ', ()=>renderEmployeeHome()); addEmpSubMenu('Profile','ðŸ‘¤',[{label:'My Profile',fn:()=>renderMyProfile()},{label:'Other Details',fn:()=>renderMyOtherDetails()},{label:'HR Tools',fn:()=>renderMyHrTools()},{label:'My Salary Details',fn:()=>renderMySalary()},{label:'My Tax Details',fn:()=>renderMyTax()}]); addEmpSubMenu('Leave','ðŸªª',[{label:'Request',fn:()=>renderLeaveApply()},{label:'My Report',fn:()=>renderMyLeaveReport()}]); } }
function addNavMain(label,icon,onClick,active=false){ const el=document.createElement('div'); el.className='nav-item'+(active?' active':''); el.innerHTML=`<div class="icon">${icon}</div><div class="label">${label}</div>`; el.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));el.classList.add('active'); onClick();}; navMain.appendChild(el); }
function addNavAdminItem(label,icon,onClick){ const el=document.createElement('div'); el.className='nav-item'; el.innerHTML=`<div class="icon">${icon}</div><div class="label">${label}</div>`; el.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); onClick();}; navAdmin.appendChild(el); }
function addNavEmpItem(label,icon,onClick){ const el=document.createElement('div'); el.className='nav-item'; el.innerHTML=`<div class="icon">${icon}</div><div class="label">${label}</div>`; el.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); onClick(); }; navEmp.appendChild(el); }
function addEmpSubMenu(title,icon,items){ const wrapper=document.createElement('div'); wrapper.className='nav-item'; wrapper.innerHTML=`<div class="icon">${icon}</div><div class="label">${title}</div>`; wrapper.onclick=()=>wrapper.classList.toggle('expanded'); navEmp.appendChild(wrapper); const sub=document.createElement('div'); sub.className='submenu'; items.forEach(it=>{ const s=document.createElement('div'); s.className='sub'; s.textContent=it.label; s.onclick=()=>{ it.fn(); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); wrapper.classList.add('active'); }; sub.appendChild(s); }); navEmp.appendChild(sub); }

/* role helpers */
function isEmployee(){ return APP.currentUser && APP.currentUser.role === 'employee'; }
function isSuperAdmin(){ return APP.currentUser && APP.currentUser.role === 'superadmin'; }
function isAdminOrHr(){ return APP.currentUser && (APP.currentUser.role === 'admin' || APP.currentUser.role === 'hr' || APP.currentUser.role === 'superadmin'); }

/* ---------- Pages ---------- */
async function renderAdminDashboard(){
  currentView='adminDashboard';
  pageTitle.textContent='Admin Dashboard';
  pageSubtitle.textContent='Overview & Quick Actions';
  mainContent.innerHTML='';
  
  const employees = await getEmployees();
  const todayAtt = await getAllAttendanceToday();
  const pendingLeaves = await getLeaves('Pending');
  const allLeaves = await getLeaves();
  const today = todayKey();
  
  // Calculate statistics
  let totalHoursToday = 0;
  let lateCount = 0;
  let absentCount = 0;
  let activeTimers = 0;
  const presentEmployees = new Set();
  
  for(const att of todayAtt){
    if(att.activeTimer) activeTimers++;
    if(att.isLate) lateCount++;
    if(att.totalHours) totalHoursToday += att.totalHours;
    if(att.employeeID) presentEmployees.add(att.employeeID);
  }
  absentCount = employees.length - presentEmployees.size;
  
  const approvedLeaves = allLeaves.filter(l => l.status === 'Approved').length;
  const rejectedLeaves = allLeaves.filter(l => l.status === 'Rejected').length;
  
  // Statistics Tiles
  const tiles=document.createElement('div');
  tiles.className='tiles';
  tiles.appendChild(makeTile('Total Employees', employees.length));
  tiles.appendChild(makeTile('Present Today', todayAtt.length));
  tiles.appendChild(makeTile('Absent Today', absentCount));
  tiles.appendChild(makeTile('Active Timers', activeTimers));
  tiles.appendChild(makeTile('Late Entries', lateCount));
  tiles.appendChild(makeTile('Pending Leaves', pendingLeaves.length));
  mainContent.appendChild(tiles);
  
  // Quick Actions Row
  const quickActions = document.createElement('div');
  quickActions.className='card';
  quickActions.style.marginTop='12px';
  quickActions.innerHTML='<h3 style="margin-top:0">Quick Actions</h3>';
  const actionGrid = document.createElement('div');
  actionGrid.style.display='grid';
  actionGrid.style.gridTemplateColumns='repeat(auto-fit, minmax(150px, 1fr))';
  actionGrid.style.gap='8px';
  actionGrid.style.marginTop='10px';
  
  const quickBtn = (label, icon, onClick) => {
    const btn = document.createElement('button');
    btn.className='btn ghost';
    btn.style.display='flex';
    btn.style.flexDirection='column';
    btn.style.alignItems='center';
    btn.style.gap='4px';
    btn.style.padding='12px';
    btn.innerHTML=`<div style="font-size:20px">${icon}</div><div style="font-size:12px">${label}</div>`;
    btn.onclick = onClick;
    return btn;
  };
  
  actionGrid.appendChild(quickBtn('Add Employee', 'âž•', ()=>renderEmployeeAddForm()));
  actionGrid.appendChild(quickBtn('View Attendance', 'ðŸ“Š', ()=>renderAttendanceManagement()));
  actionGrid.appendChild(quickBtn('Manage Leaves', 'ðŸ“…', ()=>renderAttendanceManagement()));
  actionGrid.appendChild(quickBtn('Run Payroll', 'ðŸ’°', ()=>renderPayroll()));
  actionGrid.appendChild(quickBtn('Export Reports', 'ðŸ“¥', ()=>renderReports()));
  actionGrid.appendChild(quickBtn('Settings', 'âš™ï¸', ()=>renderSettings()));
  
  quickActions.appendChild(actionGrid);
  mainContent.appendChild(quickActions);
  
  // Two Column Layout
  const twoCol = document.createElement('div');
  twoCol.style.display='grid';
  twoCol.style.gridTemplateColumns='1fr 1fr';
  twoCol.style.gap='12px';
  twoCol.style.marginTop='12px';
  
  // Left Column - Today's Attendance
  const attendCard = document.createElement('div');
  attendCard.className='card';
  attendCard.innerHTML='<h3 style="margin-top:0">Today\'s Attendance</h3><div class="tiny">' + today + '</div>';
  
  const attTable = document.createElement('table');
  attTable.className='table';
  attTable.style.marginTop='10px';
  attTable.innerHTML='<thead><tr><th>Employee</th><th>Clock In</th><th>Clock Out</th><th>Hours</th><th>Status</th></tr></thead>';
  const attTbody = document.createElement('tbody');
  
  const displayedEmps = employees.slice(0, 10);
  for(const e of displayedEmps){
    const rec = await getAttendance(e.employeeID || e.id, today);
    const tr = document.createElement('tr');
    const timeIn = rec?.timeIn ? new Date(rec.timeIn.toDate()).toLocaleTimeString().slice(0,5) : 'â€”';
    const timeOut = rec?.timeOut ? new Date(rec.timeOut.toDate()).toLocaleTimeString().slice(0,5) : (rec?.activeTimer ? 'Active' : 'â€”');
    const hours = rec?.totalHours ? rec.totalHours.toFixed(2) + 'h' : (rec?.activeTimer ? 'ðŸŸ¢' : 'â€”');
    const status = rec?.status || (rec ? 'Present' : 'Absent');
    const statusColor = rec?.isLate ? 'color:#f59e0b' : rec ? 'color:var(--accent-2)' : 'color:var(--muted)';
    tr.innerHTML = `<td>${e.name}</td><td>${timeIn}</td><td>${timeOut}</td><td>${hours}</td><td style="${statusColor}">${status}</td>`;
    attTbody.appendChild(tr);
  }
  attTable.appendChild(attTbody);
  attendCard.appendChild(attTable);
  
  if(employees.length > 10){
    const viewAll = document.createElement('button');
    viewAll.className='btn ghost';
    viewAll.style.marginTop='8px';
    viewAll.style.width='100%';
    viewAll.textContent='View All Attendance';
    viewAll.onclick = ()=>renderAttendanceManagement();
    attendCard.appendChild(viewAll);
  }
  
  // Right Column - Pending Leaves
  const leavesCard = document.createElement('div');
  leavesCard.className='card';
  leavesCard.innerHTML='<h3 style="margin-top:0">Pending Leave Requests</h3>';
  
  if(pendingLeaves.length === 0){
    leavesCard.innerHTML += '<div class="tiny" style="margin-top:10px;color:var(--muted)">No pending leave requests</div>';
  } else {
    const leavesList = document.createElement('div');
    leavesList.style.marginTop='10px';
    leavesList.style.display='flex';
    leavesList.style.flexDirection='column';
    leavesList.style.gap='8px';
    
    for(const l of pendingLeaves.slice(0, 5)){
      const leaveItem = document.createElement('div');
      leaveItem.style.padding='10px';
      leaveItem.style.background='rgba(79,70,229,0.05)';
      leaveItem.style.borderRadius='8px';
      leaveItem.style.display='flex';
      leaveItem.style.justifyContent='space-between';
      leaveItem.style.alignItems='center';
      leaveItem.innerHTML = `
        <div>
          <div style="font-weight:700">${l.name}</div>
          <div class="tiny">${l.leaveType || l.type} â€” ${l.days} day(s)</div>
          <div class="tiny" style="color:var(--muted)">${l.startDate || l.from} to ${l.endDate || l.to}</div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn primary" style="font-size:11px;padding:4px 8px">Approve</button>
          <button class="btn ghost" style="font-size:11px;padding:4px 8px">Reject</button>
        </div>
      `;
      const approveBtn = leaveItem.querySelector('.btn.primary');
      const rejectBtn = leaveItem.querySelector('.btn.ghost');
      approveBtn.onclick = async () => {
        await saveLeave({status:'Approved'}, l.id);
        showToast({title:'Leave Approved', message:`${l.name}'s leave approved`, level:'success'});
        await renderAdminDashboard();
      };
      rejectBtn.onclick = async () => {
        await saveLeave({status:'Rejected'}, l.id);
        showToast({title:'Leave Rejected', message:`${l.name}'s leave rejected`, level:'warn'});
        await renderAdminDashboard();
      };
      leavesList.appendChild(leaveItem);
    }
    leavesCard.appendChild(leavesList);
    
    if(pendingLeaves.length > 5){
      const viewAll = document.createElement('button');
      viewAll.className='btn ghost';
      viewAll.style.marginTop='8px';
      viewAll.style.width='100%';
      viewAll.textContent='View All Leaves';
      viewAll.onclick = ()=>renderAttendanceManagement();
      leavesCard.appendChild(viewAll);
    }
  }
  
  twoCol.appendChild(attendCard);
  twoCol.appendChild(leavesCard);
  mainContent.appendChild(twoCol);
  
  // Summary Stats Card
  const summaryCard = document.createElement('div');
  summaryCard.className='card';
  summaryCard.style.marginTop='12px';
  summaryCard.innerHTML='<h3 style="margin-top:0">Today\'s Summary</h3>';
  const summaryGrid = document.createElement('div');
  summaryGrid.style.display='grid';
  summaryGrid.style.gridTemplateColumns='repeat(auto-fit, minmax(200px, 1fr))';
  summaryGrid.style.gap='12px';
  summaryGrid.style.marginTop='10px';
  
  const summaryItems = [
    ['Total Hours Today', totalHoursToday.toFixed(1) + 'h'],
    ['Average Hours', employees.length > 0 ? (totalHoursToday / Math.max(todayAtt.length, 1)).toFixed(1) + 'h' : '0h'],
    ['On Leave Today', approvedLeaves],
    ['Attendance Rate', employees.length > 0 ? ((todayAtt.length / employees.length) * 100).toFixed(1) + '%' : '0%']
  ];
  
  summaryItems.forEach(([label, value]) => {
    const item = document.createElement('div');
    item.style.padding='10px';
    item.style.background='linear-gradient(180deg,#fff,#fbfdff)';
    item.style.borderRadius='8px';
    item.style.border='1px solid rgba(11,18,32,0.03)';
    item.innerHTML = `<div class="tiny" style="color:var(--muted)">${label}</div><div style="font-weight:800;font-size:20px;margin-top:4px">${value}</div>`;
    summaryGrid.appendChild(item);
  });
  
  summaryCard.appendChild(summaryGrid);
  mainContent.appendChild(summaryCard);
  
  await refreshRecent();
}

async function renderEmployeeHome(){
  currentView='employeeHome';
  pageTitle.textContent='Home';
  pageSubtitle.textContent='Personal overview';
  mainContent.innerHTML='';
  
  const emp = APP.employeeData || { name: APP.currentUser?.displayName || 'Employee', employeeID: APP.currentUser?.employeeID, role: 'employee', department: '', position: '' };
  const employeeID = emp.employeeID || APP.currentUser?.employeeID;
  const today = todayKey();
  const todayAtt = await getAttendance(employeeID, today);
  
  const land=document.createElement('div');
  land.className='landscape';
  const left=document.createElement('div');
  left.className='left';
  left.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div class="avatar">${emp.name.slice(0,2).toUpperCase()}</div><div><div style="font-weight:800">${emp.name}</div><div class="tiny">${emp.position || emp.role || 'Employee'}</div><div class="tiny">${emp.department || ''}</div><div class="tiny" style="margin-top:4px"><strong>ID:</strong> ${employeeID}</div></div></div><div style="height:8px"></div><button class="btn ghost" onclick="alert('Contact manager (demo)')">View Manager Details</button>`;
  
  const right=document.createElement('div');
  right.className='right';
  right.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">ATTENDANCE</div><div class="tiny">Today: ${today}</div></div>`;
  
  const grid=document.createElement('div');
  grid.className='stats-grid';
  const timeIn = todayAtt?.timeIn ? new Date(todayAtt.timeIn.toDate()).toLocaleTimeString().slice(0,5) : 'â€”';
  const timeOut = todayAtt?.timeOut ? new Date(todayAtt.timeOut.toDate()).toLocaleTimeString().slice(0,5) : 'â€”';
  const totalHours = todayAtt?.totalHours || (todayAtt?.activeTimer ? calculateHours(todayAtt.timeIn?.toDate(), new Date()) : '0.0');
  const isLate = todayAtt?.timeIn ? new Date(todayAtt.timeIn.toDate()).getHours() >= 9 && new Date(todayAtt.timeIn.toDate()).getMinutes() > 30 : false;
  
  const stats=[
    ["Clock In", timeIn],
    ["Clock Out", timeOut],
    ["Total Hours", typeof totalHours === 'number' ? totalHours.toFixed(2) + 'h' : totalHours],
    ["Status", todayAtt?.activeTimer ? 'ðŸŸ¢ Active' : todayAtt ? 'âœ… Completed' : 'âšª Not Started'],
    ["Late Entry", isLate ? 'âš ï¸ Yes' : 'âœ… No'],
    ["Half Day", todayAtt?.halfDay ? 'âš ï¸ Yes' : 'âœ… No']
  ];
  
  stats.forEach(s=>{
    const sb=document.createElement('div');
    sb.className='stat';
    sb.innerHTML=`<div class="tiny">${s[0]}</div><div style="font-weight:800;margin-top:8px">${s[1]}</div>`;
    grid.appendChild(sb);
  });
  right.appendChild(grid);
  
  const actions=document.createElement('div');
  actions.style.marginTop='12px';
  
  if(!todayAtt || !todayAtt.activeTimer){
    if(!todayAtt || !todayAtt.timeOut){
      const clockInBtn=document.createElement('button');
      clockInBtn.className='btn primary';
      clockInBtn.textContent='ðŸ• Clock In';
      clockInBtn.onclick = async ()=>{ await clockIn(employeeID, emp.name); await renderEmployeeHome(); };
      actions.appendChild(clockInBtn);
      
      if(todayAtt && todayAtt.timeIn){
        const clockOutBtn=document.createElement('button');
        clockOutBtn.className='btn ghost';
        clockOutBtn.style.marginLeft='8px';
        clockOutBtn.textContent='ðŸ• Clock Out';
        clockOutBtn.onclick = async ()=>{ await clockOut(employeeID, emp.name); await renderEmployeeHome(); };
        actions.appendChild(clockOutBtn);
      }
    }
  } else {
    // Active timer - show live timer and clock out
    const timerDiv=document.createElement('div');
    timerDiv.style.padding='12px';
    timerDiv.style.background='rgba(79,70,229,0.1)';
    timerDiv.style.borderRadius='8px';
    timerDiv.style.marginBottom='8px';
    const timerLabel=document.createElement('div');
    timerLabel.className='tiny';
    timerLabel.textContent='Live Timer (Active)';
    const timerValue=document.createElement('div');
    timerValue.style.fontWeight='800';
    timerValue.style.fontSize='24px';
    timerValue.id='liveTimer';
    timerValue.textContent='00:00:00';
    timerDiv.appendChild(timerLabel);
    timerDiv.appendChild(timerValue);
    actions.appendChild(timerDiv);
    
    startTimer(todayAtt.timeIn.toDate(), timerValue);
    
    const clockOutBtn=document.createElement('button');
    clockOutBtn.className='btn primary';
    clockOutBtn.textContent='ðŸ• Clock Out';
    clockOutBtn.onclick = async ()=>{ await clockOut(employeeID, emp.name); if(APP.timerInterval) clearInterval(APP.timerInterval); await renderEmployeeHome(); };
    actions.appendChild(clockOutBtn);
  }
  
  const leaveBtn=document.createElement('button');
  leaveBtn.className='btn ghost';
  leaveBtn.style.marginLeft='8px';
  leaveBtn.textContent='Apply Leave';
  leaveBtn.onclick = ()=>renderLeaveApply();
  actions.appendChild(leaveBtn);
  
  right.appendChild(actions);
  land.appendChild(left);
  land.appendChild(right);
  mainContent.appendChild(land);
  await refreshRecent();
}

// Clock In
async function clockIn(employeeID, name){
  const now = new Date();
  const today = todayKey();
  const timeIn = Timestamp.now();
  const isLate = now.getHours() >= 9 && now.getMinutes() > 30;
  
  await saveAttendance(employeeID, today, {
    employeeID,
    name,
    date: today,
    timeIn,
    status: 'Present',
    activeTimer: true,
    isLate,
    createdAt: Timestamp.now()
  });
  
  showToast({title:'Clocked In', message:`${name} clocked in at ${now.toLocaleTimeString().slice(0,5)}`, level:'success'});
}

// Clock Out
async function clockOut(employeeID, name){
  const now = new Date();
  const today = todayKey();
  const todayAtt = await getAttendance(employeeID, today);
  
  if(!todayAtt || !todayAtt.timeIn){
    alert('Please clock in first');
    return;
  }
  
  const timeOut = Timestamp.now();
  const timeInDate = todayAtt.timeIn.toDate();
  const totalHours = calculateHours(timeInDate, now);
  const halfDay = totalHours < 4.5;
  
  await saveAttendance(employeeID, today, {
    ...todayAtt,
    timeOut,
    totalHours,
    activeTimer: false,
    halfDay,
    status: totalHours >= 8 ? 'Full Day' : halfDay ? 'Half Day' : 'Short Day'
  });
  
  showToast({title:'Clocked Out', message:`${name} clocked out. Total: ${totalHours.toFixed(2)}h`, level:'success'});
}

function calculateHours(start, end){
  return ((end - start) / (1000 * 60 * 60));
}

function startTimer(startTime, element){
  if(APP.timerInterval) clearInterval(APP.timerInterval);
  
  APP.timerInterval = setInterval(() => {
    const now = new Date();
    const diff = now - startTime;
    const hours = Math.floor(diff / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    element.textContent = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  }, 1000);
}

/* Employee create / view pages (same as before) */
function renderMyProfile(){ currentView='myProfile'; pageTitle.textContent='My Profile'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const empId=getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId); const card=document.createElement('div'); card.className='card'; if(!emp){ card.innerHTML=`<h3 style="margin-top:0">${APP.currentUser.displayName}</h3><div class="tiny muted">No HR record. Contact admin.</div>`; mainContent.appendChild(card); return; } card.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div style="width:84px;height:84px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b1220">${emp.name.slice(0,2).toUpperCase()}</div><div><h3 style="margin:0">${emp.name}</h3><div class="tiny">${emp.role}</div></div></div><div style="height:12px"></div>`; if(emp.photo) card.innerHTML += `<div style="margin-bottom:10px"><img src="${emp.photo}" style="max-width:160px;border-radius:8px;"/></div>`; card.innerHTML += `<div class="tiny"><strong>Email:</strong> ${emp.email||'â€”'}</div><div style="height:8px"></div><div class="tiny"><strong>Bio:</strong><div style="margin-top:6px">${emp.bio || '<span class="tiny muted">No bio</span>'}</div></div>`; mainContent.appendChild(card); }

/* Leave apply (employee) */
async function renderLeaveApply(){
  currentView='leaveApply';
  pageTitle.textContent='Apply Leave';
  pageSubtitle.textContent='';
  mainContent.innerHTML='';
  const panel=document.createElement('div');
  panel.className='card';
  panel.innerHTML = '<h3 style="margin-top:0">Apply for Leave</h3>';
  const form=document.createElement('div');
  form.style.display='grid';
  form.style.gap='8px';
  const type=document.createElement('select');
  type.className='input';
  ['Annual','Sick','Casual','Emergency','Other'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; type.appendChild(o); });
  const from=document.createElement('input');
  from.type='date';
  from.className='input';
  const to=document.createElement('input');
  to.type='date';
  to.className='input';
  const reason=document.createElement('textarea');
  reason.className='input';
  reason.rows=3;
  reason.placeholder='Reason for leave';
  const submit=document.createElement('button');
  submit.className='btn primary';
  submit.textContent='Apply';
  submit.onclick = async ()=>{
    if(!from.value||!to.value) return alert('Pick dates');
    const employeeID = APP.currentUser?.employeeID || APP.employeeData?.employeeID;
    const emp = APP.employeeData || { name: APP.currentUser?.displayName || 'Employee' };
    const days=Math.round((new Date(to.value)-new Date(from.value))/86400000)+1;
    const rec={
      employeeID,
      name:emp.name,
      leaveType:type.value,
      startDate:from.value,
      endDate:to.value,
      days,
      reason:reason.value,
      status:'Pending',
      appliedOn:Timestamp.now()
    };
    await saveLeave(rec);
    pushNotification({title:'Leave applied', message:`${emp.name} applied leave ${from.value}â†’${to.value}`, level:'info', targetRoles:['superadmin','admin','hr']});
    showToast({title:'Leave Applied', message:'Your leave request has been submitted for approval', level:'success'});
    if(isAdminOrHr()) await renderAttendanceManagement();
    else await renderEmployeeHome();
    await refreshRecent();
  };
  form.appendChild(type);
  form.appendChild(from);
  form.appendChild(to);
  form.appendChild(reason);
  form.appendChild(submit);
  panel.appendChild(form);
  mainContent.appendChild(panel);
}

/* ---------- Employee Management (admin) */
async function renderEmployeeManagement(){
  currentView='employeeManagement';
  if(!isAdminOrHr()) return accessDenied();
  pageTitle.textContent='Employee Management';
  pageSubtitle.textContent='Create employee records & login accounts';
  mainContent.innerHTML='';
  const panel=document.createElement('div');
  panel.className='card';
  panel.innerHTML = '<h3 style="margin-top:0">Employees</h3>';
  const actionRow=document.createElement('div');
  actionRow.style.display='flex';
  actionRow.style.justifyContent='space-between';
  actionRow.style.marginTop='10px';
  const left=document.createElement('div');
  const addBtn=document.createElement('button');
  addBtn.className='btn primary';
  addBtn.textContent='Add Employee';
  addBtn.onclick = ()=>renderEmployeeAddForm();
  left.appendChild(addBtn);
  actionRow.appendChild(left);
  const search=document.createElement('input');
  search.className='input';
  search.placeholder='Filter by name/email...';
  search.style.width='320px';
  search.oninput = ()=>renderEmployeeTable(panel, search.value.trim());
  actionRow.appendChild(search);
  panel.appendChild(actionRow);
  DATA.employees = await getEmployees();
  await renderEmployeeTable(panel, '');
  mainContent.appendChild(panel);
}

async function renderEmployeeTable(container, filter){
  const prev=container.querySelector('table');
  if(prev) prev.remove();
  const table=document.createElement('table');
  table.className='table';
  table.innerHTML='<thead><tr><th>Employee ID</th><th>Name</th><th>Email</th><th>Position</th><th>Department</th><th>Salary</th><th>Actions</th></tr></thead>';
  const tbody=document.createElement('tbody');
  const employees = DATA.employees.filter(e=>{
    if(!filter) return true;
    return (e.name && e.name.toLowerCase().includes(filter.toLowerCase())) || 
           (e.email && e.email.toLowerCase().includes(filter.toLowerCase())) ||
           (e.employeeID && e.employeeID.toLowerCase().includes(filter.toLowerCase()));
  });
  
  for(const e of employees){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.employeeID || 'â€”'}</td><td>${e.name}</td><td>${e.email||''}</td><td>${e.position||e.role||''}</td><td>${e.department||''}</td><td>${DATA.settings.currency}${e.baseSalary||0}</td><td></td>`;
    const td=tr.querySelector('td:last-child');
    const edit=document.createElement('button');
    edit.className='btn ghost';
    edit.textContent='Edit';
    edit.onclick = ()=>renderEmployeeEditForm(e.id || e.employeeID);
    td.appendChild(edit);
    
    // Check if user exists
    const userQ = query(col(firebaseDb, 'users'), where('employeeID', '==', e.employeeID || e.id));
    const userSnap = await getDocs(userQ);
    const hasLogin = !userSnap.empty;
    
    if(!hasLogin){
      const createLogin=document.createElement('button');
      createLogin.className='btn primary';
      createLogin.style.marginLeft='8px';
      createLogin.textContent='Create Login';
      createLogin.onclick = ()=>renderCreateLoginForEmployee(e.id || e.employeeID);
      td.appendChild(createLogin);
    } else {
      const lbl = document.createElement('div');
      lbl.className='tiny';
      lbl.style.display='inline-block';
      lbl.style.marginLeft='8px';
      lbl.textContent='Login exists';
      td.appendChild(lbl);
    }
    
    const del=document.createElement('button');
    del.className='btn ghost';
    del.style.marginLeft='8px';
    del.textContent='Delete';
    del.onclick = async ()=>{
      if(confirm('Delete employee & associated login?')){
        await deleteEmployee(e.id || e.employeeID);
        // Delete associated user
        if(hasLogin){
          const userDocs = await getDocs(userQ);
          userDocs.forEach(async (d) => { await deleteDoc(doc(firebaseDb, 'users', d.id)); });
        }
        await renderEmployeeManagement();
      }
    };
    td.appendChild(del);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  container.appendChild(table);
}

/* add employee with auto Employee ID */
async function renderEmployeeAddForm(){
  currentView='employeeAdd';
  pageTitle.textContent='Add Employee';
  pageSubtitle.textContent='';
  mainContent.innerHTML='';
  const panel=document.createElement('div');
  panel.className='card';
  panel.innerHTML='<h3 style="margin-top:0">Create Employee Record</h3>';
  const form=document.createElement('div');
  form.style.display='grid';
  form.style.gap='8px';
  const employeeIDField=document.createElement('input');
  employeeIDField.className='input';
  employeeIDField.placeholder='Employee ID (auto-generated)';
  employeeIDField.disabled=true;
  const name=document.createElement('input');
  name.className='input';
  name.placeholder='Full name *';
  const email=document.createElement('input');
  email.className='input';
  email.type='email';
  email.placeholder='Email *';
  const position=document.createElement('input');
  position.className='input';
  position.placeholder='Position/Job Title';
  const department=document.createElement('input');
  department.className='input';
  department.placeholder='Department';
  const role=document.createElement('select');
  role.className='input';
  ['employee','hr','admin'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; role.appendChild(o); });
  const salary=document.createElement('input');
  salary.className='input';
  salary.type='number';
  salary.placeholder='Base salary';
  const bio=document.createElement('textarea');
  bio.className='input';
  bio.rows=3;
  bio.placeholder='Short bio';
  const photo=document.createElement('input');
  photo.type='file';
  photo.accept='image/*';
  
  // Generate Employee ID
  const empId = await generateEmployeeID();
  employeeIDField.value = empId;
  
  const submit=document.createElement('button');
  submit.className='btn primary';
  submit.textContent='Create Employee';
  submit.onclick = async ()=>{
    if(!name.value || !email.value) return alert('Name and Email required');
    const empData={
      employeeID: empId,
      name:name.value.trim(),
      email:email.value.trim(),
      position:position.value.trim()||'Employee',
      department:department.value.trim()||'',
      role:role.value,
      joined:new Date().toISOString().split('T')[0],
      baseSalary:Number(salary.value||0),
      bio:bio.value||'',
      photo:null,
      createdAt:Timestamp.now()
    };
    if(photo.files && photo.files[0]){
      const r=new FileReader();
      r.onload=async ()=>{
        empData.photo = r.result;
        await saveEmployee(empData);
        showToast({title:'Employee Created', message:`Employee ${empId} created successfully`, level:'success'});
        await renderEmployeeManagement();
      };
      r.readAsDataURL(photo.files[0]);
    } else {
      await saveEmployee(empData);
      showToast({title:'Employee Created', message:`Employee ${empId} created successfully`, level:'success'});
      await renderEmployeeManagement();
    }
  };
  form.appendChild(employeeIDField);
  form.appendChild(name);
  form.appendChild(email);
  form.appendChild(position);
  form.appendChild(department);
  form.appendChild(role);
  form.appendChild(salary);
  form.appendChild(bio);
  form.appendChild(photo);
  form.appendChild(submit);
  panel.appendChild(form);
  mainContent.appendChild(panel);
}

/* edit employee */
async function renderEmployeeEditForm(empId){
  currentView='employeeEdit';
  if(!isAdminOrHr()) return accessDenied();
  pageTitle.textContent='Edit Employee';
  pageSubtitle.textContent='';
  mainContent.innerHTML='';
  const emp = DATA.employees.find(e=>(e.id===empId || e.employeeID===empId));
  if(!emp) return alert('Employee not found');
  const panel=document.createElement('div');
  panel.className='card';
  panel.innerHTML = `<h3 style="margin-top:0">Edit ${emp.name}</h3>`;
  const form=document.createElement('div');
  form.style.display='grid';
  form.style.gap='8px';
  const employeeIDField=document.createElement('input');
  employeeIDField.className='input';
  employeeIDField.value = emp.employeeID || emp.id;
  employeeIDField.disabled=true;
  const name=document.createElement('input');
  name.className='input';
  name.value = emp.name;
  const email=document.createElement('input');
  email.className='input';
  email.type='email';
  email.value = emp.email || '';
  const position=document.createElement('input');
  position.className='input';
  position.value = emp.position || '';
  position.placeholder='Position/Job Title';
  const department=document.createElement('input');
  department.className='input';
  department.value = emp.department || '';
  department.placeholder='Department';
  const role=document.createElement('select');
  role.className='input';
  ['employee','hr','admin'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if((emp.role||'employee')===r) o.selected=true; role.appendChild(o); });
  const salary=document.createElement('input');
  salary.className='input';
  salary.type='number';
  salary.value = emp.baseSalary || 0;
  const bio=document.createElement('textarea');
  bio.className='input';
  bio.rows=3;
  bio.value = emp.bio || '';
  const photo=document.createElement('input');
  photo.type='file';
  photo.accept='image/*';
  const saveBtn=document.createElement('button');
  saveBtn.className='btn primary';
  saveBtn.textContent='Save Changes';
  saveBtn.onclick = async ()=>{
    const empData={
      name: name.value.trim(),
      email: email.value.trim(),
      position: position.value.trim() || 'Employee',
      department: department.value.trim() || '',
      role: role.value,
      baseSalary: Number(salary.value||0),
      bio: bio.value,
      updatedAt: Timestamp.now()
    };
    if(photo.files && photo.files[0]){
      const r=new FileReader();
      r.onload=async ()=>{
        empData.photo = r.result;
        await saveEmployee(empData, emp.id || empId);
        showToast({title:'Saved', message:'Employee updated successfully', level:'success'});
        await renderEmployeeManagement();
      };
      r.readAsDataURL(photo.files[0]);
    } else {
      await saveEmployee(empData, emp.id || empId);
      showToast({title:'Saved', message:'Employee updated successfully', level:'success'});
      await renderEmployeeManagement();
    }
  };
  form.appendChild(employeeIDField);
  form.appendChild(name);
  form.appendChild(email);
  form.appendChild(position);
  form.appendChild(department);
  form.appendChild(role);
  form.appendChild(salary);
  form.appendChild(bio);
  form.appendChild(photo);
  form.appendChild(saveBtn);
  panel.appendChild(form);
  mainContent.appendChild(panel);
}

/* create login for employee using Firebase Auth */
async function renderCreateLoginForEmployee(empId){
  if(!isAdminOrHr()) return accessDenied();
  const emp = DATA.employees.find(e=>(e.id===empId || e.employeeID===empId));
  if(!emp) return alert('Employee not found');
  currentView='createLogin';
  pageTitle.textContent='Create Login';
  pageSubtitle.textContent=`For ${emp.name} (${emp.employeeID || empId})`;
  mainContent.innerHTML='';
  const panel=document.createElement('div');
  panel.className='card';
  panel.innerHTML=`<h3 style="margin-top:0">Create login for ${emp.name}</h3><div class="tiny" style="margin-bottom:10px">Employee ID: <strong>${emp.employeeID || empId}</strong></div>`;
  const form=document.createElement('div');
  form.style.display='grid';
  form.style.gap='8px';
  const employeeIDField=document.createElement('input');
  employeeIDField.className='input';
  employeeIDField.value = emp.employeeID || empId;
  employeeIDField.disabled=true;
  employeeIDField.placeholder='Employee ID';
  const pwd=document.createElement('input');
  pwd.className='input';
  pwd.type='password';
  pwd.placeholder='Password *';
  const role=document.createElement('select');
  role.className='input';
  ['employee','hr','admin'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if((emp.role||'employee')===r) o.selected=true; role.appendChild(o); });
  const submit=document.createElement('button');
  submit.className='btn primary';
  submit.textContent='Create Login Account';
  submit.onclick = async ()=>{
    const employeeID = emp.employeeID || empId;
    const password = pwd.value;
    const r = role.value;
    if(!password) return alert('Password required');
    
    try {
      // Create Firebase Auth user with email format: employeeID@hrms.local
      const userCred = await createUserWithEmailAndPassword(firebaseAuth, `${employeeID}@hrms.local`, password);
      // Create user document in Firestore
      await setDoc(doc(firebaseDb, 'users', userCred.user.uid), {
        employeeID,
        role: r,
        displayName: emp.name,
        email: emp.email || '',
        createdAt: Timestamp.now()
      });
      showToast({title:'Login Created', message:`Login account created for ${emp.name}. Employee ID: ${employeeID}`, level:'success'});
      await renderEmployeeManagement();
    } catch(e){
      if(e.code === 'auth/email-already-in-use') alert('Login already exists for this Employee ID');
      else alert('Error: ' + e.message);
    }
  };
  form.appendChild(employeeIDField);
  form.appendChild(pwd);
  form.appendChild(role);
  form.appendChild(submit);
  panel.appendChild(form);
  mainContent.appendChild(panel);
}

/* Attendance & Leave (admin) */
async function renderAttendanceManagement(){
  currentView='attendanceManagement';
  if(!isAdminOrHr()) return accessDenied();
  pageTitle.textContent='Attendance & Leave';
  pageSubtitle.textContent='';
  mainContent.innerHTML='';
  const card=document.createElement('div');
  card.className='card';
  card.innerHTML = '<h3 style="margin-top:0">Attendance Today</h3>';
  const table=document.createElement('table');
  table.className='table';
  table.innerHTML='<thead><tr><th>Employee ID</th><th>Name</th><th>Clock In</th><th>Clock Out</th><th>Hours</th><th>Status</th></tr></thead>';
  const tbody=document.createElement('tbody');
  const employees = await getEmployees();
  const today = todayKey();
  for(const e of employees){
    const rec = await getAttendance(e.employeeID || e.id, today);
    const tr=document.createElement('tr');
    const timeIn = rec?.timeIn ? new Date(rec.timeIn.toDate()).toLocaleTimeString().slice(0,5) : 'â€”';
    const timeOut = rec?.timeOut ? new Date(rec.timeOut.toDate()).toLocaleTimeString().slice(0,5) : 'â€”';
    const hours = rec?.totalHours ? rec.totalHours.toFixed(2) + 'h' : (rec?.activeTimer ? 'Active' : 'â€”');
    tr.innerHTML = `<td>${e.employeeID || 'â€”'}</td><td>${e.name}</td><td>${timeIn}</td><td>${timeOut}</td><td>${hours}</td><td>${rec?.status || 'â€”'}</td>`;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  card.appendChild(table);
  mainContent.appendChild(card);
  
  // Leaves card
  const leavesCard=document.createElement('div');
  leavesCard.className='card';
  leavesCard.style.marginTop='12px';
  leavesCard.innerHTML = '<h3 style="margin-top:0">Leave Requests</h3>';
  const leaves = await getLeaves();
  if(leaves.length === 0) leavesCard.innerHTML += '<div class="tiny muted">No leave requests</div>';
  else {
    const lt=document.createElement('table');
    lt.className='table';
    lt.innerHTML='<thead><tr><th>Employee ID</th><th>Name</th><th>Type</th><th>From</th><th>To</th><th>Days</th><th>Status</th><th>Action</th></tr></thead>';
    const lbody=document.createElement('tbody');
    leaves.slice().reverse().forEach(l=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${l.employeeID || 'â€”'}</td><td>${l.name}</td><td>${l.leaveType || l.type}</td><td>${l.startDate || l.from}</td><td>${l.endDate || l.to}</td><td>${l.days}</td><td>${l.status}</td><td></td>`;
      const td=tr.querySelector('td:last-child');
      if(l.status==='Pending'){
        const appr=document.createElement('button');
        appr.className='btn primary';
        appr.textContent='Approve';
        appr.onclick=async ()=>{
          await saveLeave({status:'Approved'}, l.id);
          pushNotification({title:'Leave Approved', message:`${l.name}'s leave approved`, level:'success', targetRoles:['all']});
          await renderAttendanceManagement();
        };
        const rej=document.createElement('button');
        rej.className='btn ghost';
        rej.style.marginLeft='8px';
        rej.textContent='Reject';
        rej.onclick=async ()=>{
          await saveLeave({status:'Rejected'}, l.id);
          pushNotification({title:'Leave Rejected', message:`${l.name}'s leave rejected`, level:'warn', targetRoles:['all']});
          await renderAttendanceManagement();
        };
        td.appendChild(appr);
        td.appendChild(rej);
      }
      lbody.appendChild(tr);
    });
    lt.appendChild(lbody);
    leavesCard.appendChild(lt);
  }
  mainContent.appendChild(leavesCard);
  await refreshRecent();
}

/* Employee marks present (one-time per day) */
function markPresentAndNotify(empId, name){ const key = empId+'_'+todayKey(); if(DATA.attendance[key]) return; DATA.attendance[key] = {employeeId:empId,name, date:todayKey(), status:'Present', time:new Date().toLocaleTimeString().slice(0,5)}; saveData(); pushNotification({title:'Marked Present', message:`${name} marked present.`, level:'success', targetRoles:['superadmin','admin','hr']}); if(APP.currentUser && APP.currentUser.role === 'employee') showToast({title:'Marked Present', message:'You have been marked present.', level:'success'}); if(isAdminOrHr()) renderAttendanceManagement(); else renderEmployeeHome(); refreshRecent(); }

/* small pages: payroll, reports, settings same as earlier (kept minimal) */
function renderPayroll(){ if(!isAdminOrHr()) return accessDenied(); currentView='payroll'; pageTitle.textContent='Payroll'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.innerHTML='<h3 style="margin-top:0">Payroll</h3>'; const month=document.createElement('input'); month.type='month'; month.className='input'; const run=document.createElement('button'); run.className='btn primary'; run.textContent='Run Payroll'; run.onclick = ()=>{ if(!month.value) return alert('Choose month'); const [y,m]=month.value.split('-'); DATA.employees.forEach(e=>{ const gross=Number(e.baseSalary||0); const deduction=Math.round(gross*0.10); const net=gross-deduction; DATA.payslips.push({id:'p'+Date.now()+Math.random().slice(2,6),employeeId:e.id,name:e.name,month:Number(m),year:Number(y),gross,deduction,net}); }); saveData(); alert('Payroll generated'); renderPayroll(); refreshRecent(); }; card.appendChild(month); card.appendChild(run); mainContent.appendChild(card); }
function renderReports(){ if(!isAdminOrHr()) return accessDenied(); currentView='reports'; pageTitle.textContent='Reports'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.innerHTML='<h3 style="margin-top:0">Reports</h3>'; const expA=document.createElement('button'); expA.className='btn ghost'; expA.textContent='Export Attendance CSV'; expA.onclick=()=>exportAttendanceCSV(); const expL=document.createElement('button'); expL.className='btn ghost'; expL.style.marginLeft='8px'; expL.textContent='Export Leaves CSV'; expL.onclick=()=>exportLeavesCSV(); card.appendChild(expA); card.appendChild(expL); mainContent.appendChild(card); }
async function renderSettings(){
  if(!isAdminOrHr()) return accessDenied();
  currentView='settings';
  pageTitle.textContent='Settings';
  pageSubtitle.textContent='';
  mainContent.innerHTML='';
  DATA.settings = await getSettings();
  const panel=document.createElement('div');
  panel.className='card';
  panel.innerHTML='<h3 style="margin-top:0">Settings</h3>';
  const comp=document.createElement('input');
  comp.className='input';
  comp.value = DATA.settings.companyName || 'MAFS Studio';
  const cur=document.createElement('input');
  cur.className='input';
  cur.value = DATA.settings.currency || 'â‚¹';
  const ann=document.createElement('textarea');
  ann.className='input';
  ann.rows=4;
  ann.value = DATA.announcements || '';
  const save=document.createElement('button');
  save.className='btn primary';
  save.textContent='Save';
  save.onclick=async ()=>{
    await saveSettings({companyName:comp.value, currency:cur.value});
    DATA.announcements = ann.value;
    await setDoc(doc(firebaseDb, 'settings', 'main'), {announcements: ann.value}, { merge: true });
    showToast({title:'Saved', message:'Settings updated successfully', level:'success'});
    await refreshRecent();
  };
  panel.appendChild(document.createTextNode('Company name'));
  panel.appendChild(comp);
  panel.appendChild(document.createElement('div'));
  panel.appendChild(document.createTextNode('Currency'));
  panel.appendChild(cur);
  panel.appendChild(document.createElement('div'));
  panel.appendChild(document.createTextNode('Announcements'));
  panel.appendChild(ann);
  panel.appendChild(save);
  mainContent.appendChild(panel);
}

/* utilities */
function makeTile(label,value){ const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<div class="label">${label}</div><div class="value">${value}</div>`; return t; }
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function getAttendanceForEmployee(empId,date=todayKey()){ return DATA.attendance[empId+'_'+date] || {}; }
function getEmployeeIdFromUser(user){ if(!user) return null; const byEmail = DATA.employees.find(e => e.email && user.username && e.email.split('@')[0] === user.username); if(byEmail) return byEmail.id; const prefix = user.displayName.split(' ')[0].toLowerCase(); const byName = DATA.employees.find(e => e.name && e.name.split(' ')[0].toLowerCase() === prefix); return byName ? byName.id : (DATA.employees.length ? DATA.employees[0].id : null); }
function accessDenied(){ mainContent.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML = '<h3 style="margin-top:0">Access denied</h3><div class="tiny muted">You do not have permission.</div>'; mainContent.appendChild(c); }
async function confirmAdminPasswordThen(callback){ const requireConfirm = true; if(!requireConfirm){ callback(); return; } const pwd = prompt('Enter your account password to confirm this action:'); if(pwd === null) return; const ph = await hashSHA256(pwd); if(!APP.currentUser || !APP.currentUser.passwordHash) return alert('No account info found.'); if(ph !== APP.currentUser.passwordHash) return alert('Password incorrect. Action canceled.'); callback(); }

/* create login helper used elsewhere (unchanged) */
async function createUserAccount(username,password,displayName,role='employee'){ if(DATA.users.find(u=>u.username===username)) throw new Error('username exists'); const ph = await hashSHA256(password); const u = {id:'u_'+Date.now(), username, passwordHash:ph, displayName, role}; DATA.users.push(u); saveData(); return u; }

/* export utils */
function downloadCSV(rows, filename){ const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function exportEmployeesCSV(){ const rows=[['id','name','email','role','joined','baseSalary','bio']]; DATA.employees.forEach(e=>rows.push([e.id,e.name,e.email||'',e.role||'',e.joined||'',e.baseSalary||0,e.bio||''])); downloadCSV(rows,'employees.csv'); }
function exportAttendanceCSV(){ const rows=[['employeeId','name','date','status','time']]; Object.values(DATA.attendance).forEach(a=>rows.push([a.employeeId,a.name,a.date,a.status,a.time||''])); downloadCSV(rows,'attendance.csv'); }
function exportLeavesCSV(){ const rows=[['id','employeeId','name','type','from','to','days','status','appliedOn']]; DATA.leaves.forEach(l=>rows.push([l.id,l.employeeId,l.name,l.type,l.from,l.to,l.days,l.status,l.appliedOn])); downloadCSV(rows,'leaves.csv'); }

/* recent */
async function refreshRecent(){
  recentWrap.innerHTML='';
  const settings = await getSettings();
  annText.textContent = DATA.announcements || settings.announcements || 'No announcements';
  const today = todayKey();
  const todayAtt = await getAllAttendanceToday();
  const att = todayAtt.slice(0,6).map(a=>({t:'Attendance',txt:`${a.name} â€” ${a.status || 'Present'} ${a.timeIn ? new Date(a.timeIn.toDate()).toLocaleTimeString().slice(0,5) : ''}`}));
  const leaves = DATA.leaves.slice().reverse().slice(0,6).map(l=>({t:'Leave',txt:`${l.name} â€” ${l.leaveType || l.type} (${l.status})`}));
  const items = att.concat(leaves).slice(0,8);
  items.forEach(it=>{
    const c=document.createElement('div');
    c.style.minWidth='220px';
    c.style.padding='12px';
    c.style.borderRadius='12px';
    c.style.background='linear-gradient(180deg,#fff,#fbfdff)';
    c.style.border='1px solid rgba(11,18,32,0.03)';
    c.innerHTML = `<div style="font-weight:700">${it.t}</div><div class="tiny" style="margin-top:8px;color:var(--muted)">${it.txt}</div>`;
    recentWrap.appendChild(c);
  });
}

/* show pending notifications when login or external update */
function showPendingNotificationsForCurrentUser(){ if(!APP.currentUser || !DATA.notifications) return; const recent = DATA.notifications.slice().reverse().filter(n=>matchesCurrentUserRole(n.targetRoles)).slice(0,5); recent.forEach(n=>showToast(n)); }

/* mark present called by employee button */
function markPresentAndNotify(empId, name){ const key = empId+'_'+todayKey(); if(DATA.attendance[key]) return; DATA.attendance[key] = {employeeId:empId,name,date:todayKey(),status:'Present',time:new Date().toLocaleTimeString().slice(0,5)}; saveData(); pushNotification({title:'Marked Present', message:`${name} marked present.`, level:'success', targetRoles:['superadmin','admin','hr']}); if(APP.currentUser && APP.currentUser.role === 'employee') showToast({title:'Marked Present', message:'You have been marked present.', level:'success'}); if(isAdminOrHr()) renderAttendanceManagement(); else renderEmployeeHome(); refreshRecent(); }

/* sign out */
sideSignOut.onclick = async () => {
  if(confirm('Sign out?')){
    try {
      await signOut(firebaseAuth);
      APP.currentUser = null;
      APP.employeeData = null;
      if(APP.timerInterval) clearInterval(APP.timerInterval);
      app.style.display='none';
      loginWrap.style.display='flex';
      loginUser.value='';
      loginPass.value='';
    } catch(e){ alert('Error signing out: ' + e.message); }
  }
};
exportCSVs.onclick = ()=>{ exportEmployeesCSV(); exportAttendanceCSV(); exportLeavesCSV(); alert('Exported CSVs'); };
if(exportAll) exportAll.onclick = ()=>exportEmployeesCSV();

/* expose for debugging */
window.MAFS = { DATA, db: firebaseDb, auth: firebaseAuth, getEmployees, saveEmployee };

/* initial UI remains driven by first-run and login handlers above */
</script>
</body>
</html>
