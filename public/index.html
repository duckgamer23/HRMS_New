<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MAFS HRMS ‚Äî Updated Attendance Rules</title>
<style>
:root{
  --bg:#f5f8fb; --panel:#ffffff; --muted:#6b7280; --accent:#4f46e5; --accent-2:#22c1c3;
  --text:#0b1220; --glass: rgba(11,18,32,0.04); --shadow: 0 10px 30px rgba(11,18,32,0.06);
  --radius:12px;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef5fb);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;min-height:100vh;align-items:stretch}
.sidebar{width:300px;padding:26px;background:linear-gradient(180deg,#fff,#f3fbff);border-right:1px solid var(--glass);display:flex;flex-direction:column;gap:18px;box-shadow:var(--shadow)}
.brand{display:flex;align-items:center;gap:12px;font-weight:800;color:var(--accent);font-size:18px}
.brand .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:18px}
.side-search input{width:100%;padding:10px;border-radius:999px;border:1px solid rgba(11,18,32,0.06);background:transparent;color:var(--muted)}
.nav-group{margin-top:6px}
.nav-title{font-weight:700;color:var(--muted);font-size:12px;margin:10px 6px}
.nav-list{display:flex;flex-direction:column;gap:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:none;background:transparent;cursor:pointer;color:var(--muted)}
.nav-item .icon{width:36px;height:36px;border-radius:8px;background:rgba(11,18,32,0.03);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}
.nav-item .label{font-weight:600}
.nav-item:hover{color:var(--text);background:linear-gradient(90deg, rgba(79,70,229,0.06), rgba(34,193,195,0.03))}
.nav-item.active{background:linear-gradient(90deg, rgba(79,70,229,0.14), rgba(34,193,195,0.06));color:var(--text);box-shadow:0 8px 24px rgba(79,70,229,0.04)}
.submenu{margin-left:48px;display:flex;flex-direction:column;gap:6px;margin-top:6px}
.submenu .sub{padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
.submenu .sub:hover{background:rgba(79,70,229,0.04);color:var(--text)}
.user-area{margin-top:auto;display:flex;align-items:center;gap:12px;padding-top:10px;border-top:1px solid rgba(11,18,32,0.03)}
.user-area .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,#fff,#f0f4f8);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--text)}
.user-area .meta{font-size:13px;color:var(--muted)}
.signout-btn{border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:12px}
.main{flex:1;padding:28px;display:flex;flex-direction:column;gap:18px}
.topbar{display:flex;justify-content:space-between;align-items:center}
.searchbar{display:flex;gap:12px;align-items:center}
.searchbar input{padding:10px;border-radius:10px;border:1px solid rgba(11,18,32,0.06);width:320px}
.columns{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
.card{background:var(--panel);border-radius:var(--radius);padding:16px;border:1px solid rgba(11,18,32,0.03);box-shadow:var(--shadow)}
.tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.tile{padding:14px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid rgba(11,18,32,0.03)}
.tile .label{font-size:12px;color:var(--muted)}
.tile .value{font-weight:800;font-size:26px;margin-top:6px}
.landscape{display:flex;gap:18px;border-radius:12px;overflow:hidden;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
.landscape .left{padding:18px;flex:0 0 420px;display:flex;flex-direction:column;gap:10px}
.landscape .left .avatar{width:84px;height:84px;border-radius:12px;background:white;color:#0b1220;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px}
.landscape .right{background:#fff;color:var(--text);padding:18px;flex:1;display:flex;flex-direction:column;gap:12px}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.stat{background:#fbfdff;padding:10px;border-radius:10px;border:1px solid rgba(11,18,32,0.03)}
.table{width:100%;border-collapse:collapse}
.table th{font-size:13px;color:var(--muted);text-align:left;padding:8px}
.table td{padding:10px;border-top:1px solid rgba(11,18,32,0.04)}
.form-row{display:flex;gap:8px}
.input{padding:10px;border-radius:8px;border:1px solid rgba(11,18,32,0.06);width:100%}
.btn{padding:9px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);color:var(--muted)}
.tiny{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:24px;top:24px;min-width:280px;padding:12px;border-radius:10px;border:1px solid rgba(11,18,32,0.06);background:linear-gradient(180deg,#ffffff,#f8fdff);box-shadow:0 8px 20px rgba(11,18,32,0.08);z-index:9999}
.toast.success{border-left:6px solid var(--accent-2)}
.toast.warn{border-left:6px solid #f59e0b}
@media(max-width:1100px){ .sidebar{display:none} .columns{grid-template-columns:1fr} }
</style>
<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyC21spMSCxJiFujIhAws1o8Uj4tKj8oD7Q",
    authDomain: "hrms-new-36aec.firebaseapp.com",
    projectId: "hrms-new-36aec",
    storageBucket: "hrms-new-36aec.firebasestorage.app",
    messagingSenderId: "174602894316",
    appId: "1:174602894316:web:e4f744e0d4280ea6ea1ec9",
    measurementId: "G-LZNCY029F9"
  };

  // Initialize Firebase
  const firebaseApp = initializeApp(firebaseConfig);
  const analytics = getAnalytics(firebaseApp);
  const db = getFirestore(firebaseApp);

  // Make Firebase app available globally if needed
  window.firebaseApp = firebaseApp;
  window.firebaseAnalytics = analytics;
  window.firebaseDb = db;
</script>
</head>
<body>

<!-- LOGIN / FIRST RUN (create SuperAdmin) -->
<div id="loginWrap" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(11,18,32,0.06);z-index:999">
  <div style="width:520px;background:var(--panel);border-radius:12px;padding:22px;box-shadow:var(--shadow)">
    <h2 style="margin:0 0 10px 0">MAFS HRMS ‚Äî <span id="loginTitle">Sign in</span></h2>
    <div class="tiny" style="margin-bottom:12px;color:var(--muted)"><span id="loginSubtitle">Sign in as <strong>Employee</strong>, <strong>Admin</strong>, or <strong>Super-Admin</strong></span></div>
    <div id="firstRunNote" class="tiny" style="display:none;margin-bottom:10px;padding:8px;background:rgba(79,70,229,0.1);border-radius:6px;color:var(--accent)"><strong>First-time Setup:</strong> Create the first Super-Admin account. After this, you can create employee and admin accounts from the dashboard.</div>
    
    <!-- Login Form -->
    <div id="loginForm" style="display:grid;gap:8px">
      <input id="loginUser" placeholder="Username" class="input"/>
      <input id="loginPass" type="password" placeholder="Password" class="input"/>
      <div style="display:flex;gap:8px">
        <button id="loginBtn" class="btn primary">Sign in</button>
        <button id="createSuperBtn" class="btn ghost" style="display:none">Create Super-Admin</button>
      </div>
      <div id="loginMsg" class="tiny" style="color:#c0392b"></div>
      <div class="tiny" style="margin-top:8px;color:var(--muted);text-align:center">
        Don't have an account? <a href="#" id="showSignupLink" style="color:var(--accent);cursor:pointer;text-decoration:underline">Sign up for Super-Admin</a>
      </div>
    </div>
    
    <!-- Signup Form -->
    <div id="signupForm" style="display:none">
      <input id="signupUser" placeholder="Username (e.g., your email)" class="input"/>
      <input id="signupPass" type="password" placeholder="Password" class="input"/>
      <input id="signupPassConfirm" type="password" placeholder="Confirm Password" class="input"/>
      <input id="signupDisplayName" placeholder="Display Name" class="input"/>
      <select id="signupRole" class="input">
        <option value="superadmin">Super-Admin</option>
        <option value="admin">Admin</option>
        <option value="employee">Employee</option>
      </select>
      <div style="display:flex;gap:8px">
        <button id="signupBtn" class="btn primary">Create Account</button>
        <button id="cancelSignupBtn" class="btn ghost">Cancel</button>
      </div>
      <div id="signupMsg" class="tiny" style="color:#c0392b"></div>
      <div class="tiny" style="margin-top:8px;color:var(--muted);text-align:center">
        Already have an account? <a href="#" id="showLoginLink" style="color:var(--accent);cursor:pointer;text-decoration:underline">Sign in</a>
      </div>
    </div>
      <div id="debugPanel" style="margin-top:12px;padding:10px;background:rgba(79,70,229,0.05);border-radius:6px;font-size:11px;display:none">
        <div style="font-weight:700;margin-bottom:6px">üîç Debug Info:</div>
        <div id="debugContent"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button id="createAccountsBtn" class="btn ghost" style="font-size:11px;padding:6px 10px">Create Default Accounts</button>
          <button id="clearStorageBtn" class="btn ghost" style="font-size:11px;padding:6px 10px;color:#c0392b">Clear All Data & Reset</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">
  <aside class="sidebar">
    <div class="brand"><div class="logo">M</div> MAFS HRMS</div>
    <div class="side-search"><input id="sideSearch" placeholder="Search employees..." /></div>

    <div class="nav-group"><div class="nav-title">MAIN</div><div class="nav-list" id="navMain"></div></div>
    <div class="nav-group"><div class="nav-title">EMPLOYEE</div><div class="nav-list" id="navEmp"></div></div>
    <div class="nav-group"><div class="nav-title">ADMIN</div><div class="nav-list" id="navAdmin"></div></div>

    <div class="user-area">
      <div class="avatar" id="userAvatar">S</div>
      <div><div id="userName" style="font-weight:700">‚Äî</div><div class="tiny" id="userRole">‚Äî</div></div>
      <div style="margin-left:auto"><button id="sideSignOut" class="signout-btn">Sign out</button></div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div><h3 id="pageTitle" style="margin:0">Dashboard</h3><div id="pageSubtitle" class="tiny">Overview</div></div>
      <div class="searchbar"><input id="globalSearch" placeholder="Quick search employees..." /><button id="exportAll" class="btn ghost">Export</button></div>
    </div>

    <div class="columns">
      <div><div id="mainContent"></div></div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Recent Activity</strong><div class="tiny">Attendance & leaves</div></div>
            <div><button id="exportCSVs" class="btn ghost">Export CSVs</button></div>
          </div>
          <div style="height:12px"></div>
          <div id="recentWrap" style="display:flex;gap:12px;overflow-x:auto;padding-bottom:8px"></div>
        </div>

        <div style="height:12px"></div>

        <div class="card"><strong>Announcements</strong><div id="annText" class="tiny" style="margin-top:10px">No announcements</div></div>
      </div>
    </div>
  </main>
</div>

<!-- Toast root -->
<div id="toastRoot" aria-live="polite" style="position:fixed;right:20px;top:20px;z-index:9999"></div>

<script>
/* Updated HRMS single file
   - If employee already has login -> "Create Login" button removed
   - Employee 'Mark Present' can be done once per day; then button hidden for that day
   - Admin table shows only current status (no action buttons)
   - Local storage sync + notifications remain
*/

const STORAGE_KEY = 'mafs_hrms_att_once_v1';
const FIRESTORE_DOC_ID = 'hrms_data';

let firestoreReady = false;
let firestoreUnsubscribe = null;

// Check if Firestore is available
function checkFirestore(){
  if(typeof window !== 'undefined' && window.firebaseDb){
    return window.firebaseDb;
  }
  return null;
}

// Load data from localStorage first (fast), then sync with Firestore in background
async function loadData(syncFirestore = true){
  // Load from localStorage first (instant, no network delay)
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    const init={users:[],employees:[],attendance:{},leaves:[],payslips:[],announcements:'',settings:{companyName:'MAFS Studio',currency:'‚Çπ'},notifications:[]};
    localStorage.setItem(STORAGE_KEY,JSON.stringify(init));
    // Sync to Firestore in background (non-blocking)
    if(syncFirestore) syncToFirestoreInBackground(init);
    return init;
  }
  
  let localData;
  try{
    localData = JSON.parse(raw);
  } catch(e){
    console.error('storage parse',e);
    localStorage.removeItem(STORAGE_KEY);
    return loadData(syncFirestore);
  }
  
  // Sync with Firestore in background (non-blocking)
  if(syncFirestore) syncToFirestoreInBackground(localData);
  
  return localData;
}

// Sync data with Firestore in background (non-blocking)
async function syncToFirestoreInBackground(localData){
  const db = checkFirestore();
  if(!db) return;
  
  // Run in background without blocking
  (async () => {
    try {
      const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
      const dataDoc = doc(db, 'hrms_data', FIRESTORE_DOC_ID);
      const docSnap = await getDoc(dataDoc);
      
      if(docSnap.exists()){
        // Firestore has data - compare with local data
        const firestoreData = docSnap.data();
        
        // Count items in each dataset
        const localUsersCount = (localData.users && localData.users.length) || 0;
        const localEmployeesCount = (localData.employees && localData.employees.length) || 0;
        const firestoreUsersCount = (firestoreData.users && firestoreData.users.length) || 0;
        const firestoreEmployeesCount = (firestoreData.employees && firestoreData.employees.length) || 0;
        
        // Only use Firestore data if it has MORE content (likely newer)
        const localTotal = localUsersCount + localEmployeesCount;
        const firestoreTotal = firestoreUsersCount + firestoreEmployeesCount;
        
        if(firestoreTotal > localTotal && firestoreData && Object.keys(firestoreData).length > 0){
          // Firestore has more data - use it
          localStorage.setItem(STORAGE_KEY, JSON.stringify(firestoreData));
          if(typeof DATA !== 'undefined' && DATA){
            Object.assign(DATA, firestoreData);
          }
        } else if(localTotal > 0) {
          // Local has data - upload to Firestore (local wins)
          await setDoc(dataDoc, localData, { merge: false });
        }
      } else {
        // No Firestore data - upload local data if it has content
        if(localData && ((localData.users && localData.users.length > 0) || (localData.employees && localData.employees.length > 0))){
          await setDoc(dataDoc, localData, { merge: false });
        }
      }
    } catch(e){
      // Silently fail - Firestore sync is optional
      console.warn('Firestore sync failed (non-critical):', e.message);
    }
  })();
}

// Save data to Firestore (online) - non-blocking
async function saveDataToFirestore(data){
  const db = checkFirestore();
  if(!db) return false;
  
  try {
    const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const dataDoc = doc(db, 'hrms_data', FIRESTORE_DOC_ID);
    await setDoc(dataDoc, data, { merge: false });
    return true;
  } catch(e){
    // Silently fail - Firestore is optional
    return false;
  }
}

// Save data function (saves to both Firestore and localStorage)
async function saveData(waitForFirestore = false){
  // Save to localStorage immediately (fast, local backup)
  localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA));
  
  // Save to Firestore
  if(waitForFirestore){
    // Wait for Firestore if explicitly requested (for critical saves)
    try {
      await saveDataToFirestore(DATA);
    } catch(e) {
      console.warn('Firestore save failed (non-critical):', e.message);
    }
  } else {
    // Save to Firestore in background (non-blocking)
    saveDataToFirestore(DATA).catch(e => {
      console.warn('Firestore save failed (non-critical):', e.message);
    });
  }
  
  broadcastChange();
}

// Setup Firestore real-time listener for multi-device sync
async function setupFirestoreListener(){
  const db = checkFirestore();
  if(!db) return;
  
  try {
    const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const dataDoc = doc(db, 'hrms_data', FIRESTORE_DOC_ID);
    
    firestoreUnsubscribe = onSnapshot(dataDoc, (docSnap) => {
      if(docSnap.exists()){
        const firestoreData = docSnap.data();
        // Update DATA without triggering save (to avoid loop)
        Object.assign(DATA, firestoreData);
        // Update localStorage
        localStorage.setItem(STORAGE_KEY, JSON.stringify(firestoreData));
        // Refresh UI if needed
        onExternalUpdate();
      }
    }, (error) => {
      // Silently handle errors - Firestore is optional
    });
    
    firestoreReady = true;
  } catch(e){
    console.error('‚ùå Firestore listener setup error:', e);
  }
}

let DATA = null;
let APP = { currentUser: null };

// Initialize DATA asynchronously - optimized for fast page load
(async function initData(){
  // Load from localStorage first (instant) - don't wait for Firestore
  DATA = await loadData(false); // false = don't sync Firestore yet
  
  // Initialize the app immediately (fast UI)
  await init();
  
  // Setup Firestore sync in background (non-blocking)
  setupFirestoreListener().catch(e => {
    console.warn('Firestore listener setup failed (non-critical):', e.message);
  });
  
  // Sync with Firestore in background after UI is shown
  syncToFirestoreInBackground(DATA);
})();

async function hashSHA256(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* DOM refs */
const loginWrap = document.getElementById('loginWrap'), firstRunNote = document.getElementById('firstRunNote'), createSuperBtn = document.getElementById('createSuperBtn'), loginBtn = document.getElementById('loginBtn'), loginUser = document.getElementById('loginUser'), loginPass = document.getElementById('loginPass'), loginMsg = document.getElementById('loginMsg');
const loginForm = document.getElementById('loginForm'), signupForm = document.getElementById('signupForm');
const loginTitle = document.getElementById('loginTitle'), loginSubtitle = document.getElementById('loginSubtitle');
const showSignupLink = document.getElementById('showSignupLink'), showLoginLink = document.getElementById('showLoginLink');
const signupBtn = document.getElementById('signupBtn'), cancelSignupBtn = document.getElementById('cancelSignupBtn');
const signupUser = document.getElementById('signupUser'), signupPass = document.getElementById('signupPass'), signupPassConfirm = document.getElementById('signupPassConfirm'), signupDisplayName = document.getElementById('signupDisplayName'), signupRole = document.getElementById('signupRole'), signupMsg = document.getElementById('signupMsg');
const app = document.getElementById('app'), navMain = document.getElementById('navMain'), navEmp = document.getElementById('navEmp'), navAdmin = document.getElementById('navAdmin'), userAvatar = document.getElementById('userAvatar'), userName = document.getElementById('userName'), userRole = document.getElementById('userRole'), sideSignOut = document.getElementById('sideSignOut');
const mainContent = document.getElementById('mainContent'), pageTitle = document.getElementById('pageTitle'), pageSubtitle = document.getElementById('pageSubtitle');
const recentWrap = document.getElementById('recentWrap'), annText = document.getElementById('annText'), toastRoot = document.getElementById('toastRoot');
const exportCSVs = document.getElementById('exportCSVs'), exportAll = document.getElementById('exportAll');

/* storage sync */
function broadcastChange(){ try{ localStorage.setItem('__mafs_sync', JSON.stringify({ts:Date.now()})); }catch(e){ } }
window.addEventListener('storage',async (ev)=>{ if(ev.key === '__mafs_sync'){ DATA = await loadData(); onExternalUpdate(); } });

function onExternalUpdate(){ annText.textContent = DATA.announcements || 'No announcements'; refreshRecent(); if(APP.currentUser){ if(APP.currentUser.role === 'employee'){ if(currentView === 'employeeHome') renderEmployeeHome(); } else { if(currentView === 'adminDashboard') renderAdminDashboard(); if(currentView === 'attendanceManagement') renderAttendanceManagement(); if(currentView === 'employeeManagement') renderEmployeeManagement(); } } showPendingNotificationsForCurrentUser(); }

/* notifications */
async function pushNotification({title,message,level='info',targetRoles=['superadmin','admin','hr']}){ const n = {id:'n_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),title,message,level,targetRoles,ts:new Date().toISOString()}; DATA.notifications = DATA.notifications || []; DATA.notifications.push(n); await saveData(); if(matchesCurrentUserRole(n.targetRoles)) showToast(n); }
function showToast(n){ const el = document.createElement('div'); el.className='toast' + (n.level==='success' ? ' success' : n.level==='warn' ? ' warn' : ''); el.innerHTML = `<div style="font-weight:700">${n.title}</div><div class="tiny" style="margin-top:8px;color:var(--muted)">${n.message}</div>`; toastRoot.appendChild(el); setTimeout(()=>{ el.style.transition='opacity 300ms'; el.style.opacity=0; setTimeout(()=>el.remove(),350); },5000); }
function matchesCurrentUserRole(targetRoles){ if(!APP.currentUser) return false; return targetRoles.indexOf(APP.currentUser.role) !== -1 || targetRoles.indexOf('all') !== -1; }
function showPendingNotificationsForCurrentUser(){ if(!APP.currentUser || !DATA.notifications) return; const recent = DATA.notifications.slice().reverse().filter(n=>matchesCurrentUserRole(n.targetRoles)).slice(0,5); recent.forEach(n=>showToast(n)); }

/* Update debug panel */
async function updateDebugPanel(){
  const panel = document.getElementById('debugPanel');
  const content = document.getElementById('debugContent');
  if(!panel || !content) return;
  
  DATA = await loadData();
  const userCount = DATA.users ? DATA.users.length : 0;
  
  if(userCount === 0){
    content.innerHTML = '<span style="color:#c0392b">‚ùå No accounts found. Click "Create Default Accounts" below.</span>';
    panel.style.display = 'block';
  } else {
    let html = `<div style="color:green">‚úÖ ${userCount} account(s) found:</div>`;
    DATA.users.forEach((u, i) => {
      html += `<div style="margin-top:4px">${i+1}. <strong>${u.username}</strong> (${u.role})</div>`;
    });
    content.innerHTML = html;
    panel.style.display = 'block';
  }
}

/* Auto-create default accounts on first load */
async function createDefaultAccounts(force = false){
  // Reload DATA first to get latest state
  DATA = await loadData();
  if(!DATA.users) DATA.users = [];
  
  console.log('üîç Checking for existing accounts...');
  console.log('Current users count:', DATA.users.length);
  
  // Check if all required accounts exist
  const requiredAccounts = [
    {username: 'kalaipraveendc@gmail.com', password: '49045028p@', displayName: 'Super Admin', role: 'superadmin'},
    {username: 'admin', password: 'admin123', displayName: 'Admin User', role: 'admin'},
    {username: 'employee', password: 'emp123', displayName: 'Employee User', role: 'employee'}
  ];
  
  let allExist = true;
  if(!force && DATA.users.length > 0){
    for(const req of requiredAccounts){
      const exists = DATA.users.find(u => u.username === req.username);
      if(!exists){
        allExist = false;
        break;
      }
    }
  } else {
    allExist = false;
  }
  
  if(allExist && !force) {
    console.log('‚úÖ All required accounts already exist:');
    DATA.users.forEach(u => console.log(`  - ${u.username} (${u.role})`));
    updateDebugPanel();
    return; // Accounts already exist
  }
  
  try {
    if(force){
      console.log('üîÑ Force creating default accounts (replacing existing)...');
    } else {
      console.log('üîÑ Creating missing default accounts...');
    }
    
    // Create/Update Super-Admin
    DATA = await loadData();
    if(!DATA.users) DATA.users = [];
    const superAdminExists = DATA.users.find(u => u.username === 'kalaipraveendc@gmail.com');
    if(!superAdminExists || force){
      if(superAdminExists && force){
        DATA.users = DATA.users.filter(u => u.username !== 'kalaipraveendc@gmail.com');
        await saveData();
        DATA = await loadData();
      }
      console.log('Creating Super-Admin account...');
      const superAdmin = await createUserAccount('kalaipraveendc@gmail.com', '49045028p@', 'Super Admin', 'superadmin');
      console.log('‚úÖ Super-Admin created:', superAdmin.username);
    }
    
    // Create/Update Admin
    DATA = await loadData();
    if(!DATA.users) DATA.users = [];
    const adminExists = DATA.users.find(u => u.username === 'admin');
    if(!adminExists || force){
      if(adminExists && force){
        DATA.users = DATA.users.filter(u => u.username !== 'admin');
        await saveData();
        DATA = await loadData();
      }
      console.log('Creating Admin account...');
      const admin = await createUserAccount('admin', 'admin123', 'Admin User', 'admin');
      console.log('‚úÖ Admin created:', admin.username);
    }
    
    // Create/Update Employee
    DATA = await loadData();
    if(!DATA.users) DATA.users = [];
    const employeeExists = DATA.users.find(u => u.username === 'employee');
    if(!employeeExists || force){
      if(employeeExists && force){
        DATA.users = DATA.users.filter(u => u.username !== 'employee');
        await saveData();
        DATA = await loadData();
      }
      console.log('Creating Employee account...');
      const employee = await createUserAccount('employee', 'emp123', 'Employee User', 'employee');
      console.log('‚úÖ Employee created:', employee.username);
    }
    
    // Final reload
    DATA = await loadData();
    
    console.log('‚úÖ Default accounts ready!');
    console.log('üìã Total accounts now:', DATA.users.length);
    console.log('üìã Login Credentials:');
    console.log('Super-Admin: username="kalaipraveendc@gmail.com", password="49045028p@"');
    console.log('Admin: username="admin", password="admin123"');
    console.log('Employee: username="employee", password="emp123"');
    
    updateDebugPanel();
  } catch(e) {
    console.error('‚ùå Error creating default accounts:', e);
    console.error('Error details:', e.message);
    console.error('Full error:', e);
    // Reload DATA even on error to ensure consistency
    DATA = await loadData();
    await updateDebugPanel();
  }
}

/* init login */
async function init(){
  // Auto-create default accounts if none exist
  await createDefaultAccounts();
  
  // Reload DATA one more time to ensure we have latest state
  DATA = await loadData();
  
  // Update debug panel
  await updateDebugPanel();
  
  // Setup create accounts button
  const createAccountsBtn = document.getElementById('createAccountsBtn');
  if(createAccountsBtn){
    createAccountsBtn.onclick = async ()=>{
      await createDefaultAccounts(true); // Force recreate
      DATA = await loadData();
      await updateDebugPanel();
      loginMsg.style.color = 'green';
      loginMsg.textContent = 'Default accounts created/updated! Try logging in now.';
    };
  }
  
  // Setup clear storage button
  const clearStorageBtn = document.getElementById('clearStorageBtn');
  if(clearStorageBtn){
    clearStorageBtn.onclick = async ()=>{
      if(confirm('‚ö†Ô∏è This will delete ALL data (users, employees, attendance, etc.). Continue?')){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem('__mafs_sync');
        DATA = await loadData(); // This will create fresh empty data
        await createDefaultAccounts(true); // Force recreate default accounts
        DATA = await loadData();
        await updateDebugPanel();
        loginMsg.style.color = 'green';
        loginMsg.textContent = 'Data cleared! Default accounts created. Try logging in now.';
      }
    };
  }
  
  if(!DATA.users || DATA.users.length === 0){
    firstRunNote.style.display = 'block';
    createSuperBtn.style.display = 'inline-block';
    loginBtn.style.display = 'none';
    createSuperBtn.onclick = async ()=>{ const u = loginUser.value.trim(); const p = loginPass.value; if(!u||!p){ loginMsg.textContent='Enter username & password'; return; } const ph = await hashSHA256(p); DATA.users.push({id:'u_'+Date.now(), username:u, passwordHash:ph, displayName:u, role:'superadmin'}); await saveData(); DATA = await loadData(); await updateDebugPanel(); loginMsg.style.color='green'; loginMsg.textContent='Super-Admin created. Sign in.'; createSuperBtn.style.display='none'; loginBtn.style.display='inline-block'; firstRunNote.style.display='none'; };
  } else { 
    firstRunNote.style.display='none'; 
    createSuperBtn.style.display='none'; 
    loginBtn.style.display='inline-block'; 
  }
  
  // Show/Hide Signup Form
  if(showSignupLink && loginForm && signupForm){
    showSignupLink.onclick = (e)=>{
      e.preventDefault();
      loginForm.style.display = 'none';
      signupForm.style.display = 'grid';
      signupForm.style.gridTemplateRows = 'auto';
      signupForm.style.gap = '8px';
      if(loginTitle) loginTitle.textContent = 'Sign up';
      if(loginSubtitle) loginSubtitle.textContent = 'Create a new account (Super-Admin, Admin, or Employee)';
      if(signupMsg) signupMsg.textContent = '';
    };
  }
  
  if(showLoginLink && loginForm && signupForm){
    showLoginLink.onclick = (e)=>{
      e.preventDefault();
      signupForm.style.display = 'none';
      loginForm.style.display = 'grid';
      if(loginTitle) loginTitle.textContent = 'Sign in';
      if(loginSubtitle) loginSubtitle.innerHTML = 'Sign in as <strong>Employee</strong>, <strong>Admin</strong>, or <strong>Super-Admin</strong>';
      if(loginMsg) loginMsg.textContent = '';
    };
  }
  
  if(cancelSignupBtn && showLoginLink){
    cancelSignupBtn.onclick = (e)=>{
      e.preventDefault();
      if(showLoginLink && showLoginLink.onclick) showLoginLink.onclick(e);
      if(signupUser) signupUser.value = '';
      if(signupPass) signupPass.value = '';
      if(signupPassConfirm) signupPassConfirm.value = '';
      if(signupDisplayName) signupDisplayName.value = '';
      if(signupRole) signupRole.value = 'superadmin';
    };
  }
  
  // Signup Button Handler
  if(signupBtn && signupUser && signupPass && signupPassConfirm && signupDisplayName && signupRole && signupMsg){
    signupBtn.onclick = async ()=>{
      if(!signupMsg) return;
      signupMsg.textContent = '';
      const username = signupUser.value.trim();
      const password = signupPass.value;
      const passwordConfirm = signupPassConfirm.value;
      const displayName = signupDisplayName.value.trim() || username;
      const role = signupRole.value;
      
      if(!username || !password || !passwordConfirm){
        signupMsg.textContent = 'Please fill in all fields';
        return;
      }
      
      if(password !== passwordConfirm){
        signupMsg.textContent = 'Passwords do not match';
        return;
      }
      
      if(password.length < 6){
        signupMsg.textContent = 'Password must be at least 6 characters';
        return;
      }
      
      try {
        DATA = await loadData();
        const existingUser = DATA.users.find(u => u.username === username);
        if(existingUser){
          signupMsg.textContent = 'Username already exists. Please choose another.';
          return;
        }
        
        const newUser = await createUserAccount(username, password, displayName, role);
        console.log('‚úÖ Account created successfully!', newUser);
        
        signupMsg.style.color = 'green';
        signupMsg.textContent = `‚úÖ ${role.charAt(0).toUpperCase() + role.slice(1)} account created! Redirecting to login...`;
        
        // Clear form
        signupUser.value = '';
        signupPass.value = '';
        signupPassConfirm.value = '';
        signupDisplayName.value = '';
        signupRole.value = 'superadmin';
        
        // Switch back to login form after 2 seconds
        setTimeout(() => {
          if(showLoginLink && showLoginLink.onclick) showLoginLink.onclick({preventDefault: ()=>{}});
          if(loginUser) loginUser.value = username;
          if(loginMsg){
            loginMsg.style.color = 'green';
            loginMsg.textContent = 'Account created! Please sign in.';
          }
        }, 2000);
        
      } catch(e){
        console.error('‚ùå Signup error:', e);
        signupMsg.textContent = 'Error creating account: ' + e.message;
      }
    };
  }
  
  if(loginBtn){
    loginBtn.onclick = async ()=>{ 
    loginMsg.textContent=''; 
    DATA = await loadData(false); // Reload DATA before login check (no Firestore sync)
    
    const u = loginUser.value.trim(); 
    const p = loginPass.value; 
    
    // Update debug panel with login attempt
    const debugContent = document.getElementById('debugContent');
    if(debugContent){
      debugContent.innerHTML += `<div style="margin-top:6px;padding:6px;background:rgba(79,70,229,0.1);border-radius:4px"><strong>Login attempt:</strong> ${u ? u : '(empty)'}</div>`;
    }
    
    if(!u||!p){ 
      loginMsg.textContent='Enter username & password'; 
      if(debugContent) debugContent.innerHTML += '<div style="color:#c0392b;margin-top:4px">‚ùå Empty username or password</div>';
      return;
    } 
    
    const user = DATA.users.find(x=>x.username===u); 
    if(!user){ 
      loginMsg.textContent='Invalid credentials - User not found'; 
      if(debugContent) debugContent.innerHTML += `<div style="color:#c0392b;margin-top:4px">‚ùå User "${u}" not found in system</div>`;
      return;
    } 
    
    if(debugContent) debugContent.innerHTML += `<div style="color:green;margin-top:4px">‚úÖ User found: ${user.username} (${user.role})</div>`;
    
    const ph = await hashSHA256(p); 
    
    if(ph !== user.passwordHash){ 
      loginMsg.textContent='Invalid credentials - Wrong password'; 
      if(debugContent) debugContent.innerHTML += '<div style="color:#c0392b;margin-top:4px">‚ùå Password incorrect</div>';
      return;
    } 
    
    if(debugContent) debugContent.innerHTML += '<div style="color:green;margin-top:4px;font-weight:700">‚úÖ Login successful! Redirecting...</div>';
    APP.currentUser = {...user}; 
    afterLogin(); 
    };
  }
}
// init() is called automatically after DATA loads - see initData() above

let currentView = null;
function afterLogin(){ loginWrap.style.display='none'; app.style.display='flex'; userAvatar.textContent = APP.currentUser.displayName.slice(0,1).toUpperCase(); userName.textContent = APP.currentUser.displayName; userRole.textContent = APP.currentUser.role; buildSidebar(); if(APP.currentUser.role === 'employee') renderEmployeeHome(); else renderAdminDashboard(); showPendingNotificationsForCurrentUser(); }

/* Sidebar builders (same pattern) */
function clearSidebar(){ navMain.innerHTML=''; navEmp.innerHTML=''; navAdmin.innerHTML=''; }
function buildSidebar(){ clearSidebar(); addNavMain('Dashboard','D', ()=>{ if(isEmployee()) renderEmployeeHome(); else renderAdminDashboard(); }, true); if(!isEmployee()){ addNavAdminItem('Employee Management','E', ()=>renderEmployeeManagement()); addNavAdminItem('Attendance & Leave','A', ()=>renderAttendanceManagement()); addNavAdminItem('Payroll','$', ()=>renderPayroll()); addNavAdminItem('Reports','R', ()=>renderReports()); addNavAdminItem('Settings','S', ()=>renderSettings()); } if(isEmployee()){ addNavEmpItem('Home','üè†', ()=>renderEmployeeHome()); addEmpSubMenu('Profile','üë§',[{label:'My Profile',fn:()=>renderMyProfile()},{label:'Other Details',fn:()=>renderMyOtherDetails()},{label:'HR Tools',fn:()=>renderMyHrTools()},{label:'My Salary Details',fn:()=>renderMySalary()},{label:'My Tax Details',fn:()=>renderMyTax()}]); addEmpSubMenu('Leave','ü™™',[{label:'Request',fn:()=>renderLeaveApply()},{label:'My Report',fn:()=>renderMyLeaveReport()}]); } }
function addNavMain(label,icon,onClick,active=false){ const el=document.createElement('div'); el.className='nav-item'+(active?' active':''); el.innerHTML=`<div class="icon">${icon}</div><div class="label">${label}</div>`; el.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));el.classList.add('active'); onClick();}; navMain.appendChild(el); }
function addNavAdminItem(label,icon,onClick){ const el=document.createElement('div'); el.className='nav-item'; el.innerHTML=`<div class="icon">${icon}</div><div class="label">${label}</div>`; el.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); onClick();}; navAdmin.appendChild(el); }
function addNavEmpItem(label,icon,onClick){ const el=document.createElement('div'); el.className='nav-item'; el.innerHTML=`<div class="icon">${icon}</div><div class="label">${label}</div>`; el.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); onClick(); }; navEmp.appendChild(el); }
function addEmpSubMenu(title,icon,items){ const wrapper=document.createElement('div'); wrapper.className='nav-item'; wrapper.innerHTML=`<div class="icon">${icon}</div><div class="label">${title}</div>`; wrapper.onclick=()=>wrapper.classList.toggle('expanded'); navEmp.appendChild(wrapper); const sub=document.createElement('div'); sub.className='submenu'; items.forEach(it=>{ const s=document.createElement('div'); s.className='sub'; s.textContent=it.label; s.onclick=()=>{ it.fn(); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); wrapper.classList.add('active'); }; sub.appendChild(s); }); navEmp.appendChild(sub); }

/* role helpers */
function isEmployee(){ return APP.currentUser && APP.currentUser.role === 'employee'; }
function isSuperAdmin(){ return APP.currentUser && APP.currentUser.role === 'superadmin'; }
function isAdminOrHr(){ return APP.currentUser && (APP.currentUser.role === 'admin' || APP.currentUser.role === 'hr' || APP.currentUser.role === 'superadmin'); }

/* ---------- Pages ---------- */
function renderAdminDashboard(){ currentView='adminDashboard'; pageTitle.textContent='Dashboard'; pageSubtitle.textContent='Admin overview'; mainContent.innerHTML=''; const tiles=document.createElement('div'); tiles.className='tiles'; tiles.appendChild(makeTile('Total Employees', DATA.employees.length)); tiles.appendChild(makeTile('Active Today', Object.values(DATA.attendance).filter(a=>a.date===todayKey()).length)); tiles.appendChild(makeTile('Pending Leaves', DATA.leaves.filter(l=>l.status==='Pending').length)); mainContent.appendChild(tiles); const snap=document.createElement('div'); snap.className='card'; snap.style.marginTop='12px'; snap.innerHTML='<h3 style="margin-top:0">Attendance Snapshot</h3><div class="tiny">Today</div>'; DATA.employees.slice(0,50).forEach(e=>{ const key=e.id+'_'+todayKey(); const rec = DATA.attendance[key]; const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='10px 0'; row.style.borderBottom='1px dashed rgba(11,18,32,0.03)'; const left=document.createElement('div'); left.textContent=e.name; left.style.color='var(--muted)'; const right=document.createElement('div'); right.textContent = rec ? rec.status + (rec.time ? ' ‚Äî ' + rec.time : '') : '‚Äî'; row.appendChild(left); row.appendChild(right); snap.appendChild(row); }); mainContent.appendChild(snap); refreshRecent(); }

function renderEmployeeHome(){ currentView='employeeHome'; pageTitle.textContent='Home'; pageSubtitle.textContent='Personal overview'; mainContent.innerHTML=''; const empId = getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId) || {name:APP.currentUser.displayName, role:APP.currentUser.role||'employee'}; const land=document.createElement('div'); land.className='landscape'; const left=document.createElement('div'); left.className='left'; left.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div class="avatar">${emp.name.slice(0,2).toUpperCase()}</div><div><div style="font-weight:800">${emp.name}</div><div class="tiny">${emp.role||'Employee'}</div></div></div><div style="height:8px"></div><button class="btn ghost" onclick="alert('Contact manager (demo)')">View Manager Details</button>`; const right=document.createElement('div'); right.className='right'; right.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">ATTENDANCE STATISTICS</div><div class="tiny">Last updated: now</div></div>`; const grid=document.createElement('div'); grid.className='stats-grid'; const stats=[["Today's Last Punch", getAttendanceForEmployee(emp.id).time || 'Unswiped'],["Tomorrow's Shift",'09:00 - 18:00'],["Today's Punch", getAttendanceForEmployee(emp.id).status || 'Unswiped'],["Holiday's this Year",'11'],["Late Marks",'0'],["LOP",'0'],["Invalid Punches",'2'],["Unpunches",'0'],["Pending OnDuty",'0']]; stats.forEach(s=>{ const sb=document.createElement('div'); sb.className='stat'; sb.innerHTML=`<div class="tiny">${s[0]}</div><div style="font-weight:800;margin-top:8px">${s[1]}</div>`; grid.appendChild(sb); }); right.appendChild(grid); const actions=document.createElement('div'); actions.style.marginTop='12px'; const key = emp.id+'_'+todayKey(); const already = !!DATA.attendance[key]; if(!already){ const markBtn=document.createElement('button'); markBtn.className='btn primary'; markBtn.textContent='Mark Present'; markBtn.onclick = ()=>{ markPresentAndNotify(emp.id, emp.name); markBtn.style.display='none'; }; actions.appendChild(markBtn); } else { // show status only (no button)
    const statusSpan = document.createElement('div'); statusSpan.className='tiny'; statusSpan.style.fontWeight='700'; statusSpan.textContent = (DATA.attendance[key] && DATA.attendance[key].status) ? DATA.attendance[key].status + (DATA.attendance[key].time ? ' ‚Äî '+DATA.attendance[key].time : '') : '‚Äî'; actions.appendChild(statusSpan);
  } const leaveBtn=document.createElement('button'); leaveBtn.className='btn ghost'; leaveBtn.style.marginLeft='8px'; leaveBtn.textContent='Apply Leave'; leaveBtn.onclick = ()=>renderLeaveApply(); actions.appendChild(leaveBtn); right.appendChild(actions); land.appendChild(left); land.appendChild(right); mainContent.appendChild(land); refreshRecent(); }

/* Employee create / view pages (same as before) */
function renderMyProfile(){ currentView='myProfile'; pageTitle.textContent='My Profile'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const empId=getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId); const card=document.createElement('div'); card.className='card'; if(!emp){ card.innerHTML=`<h3 style="margin-top:0">${APP.currentUser.displayName}</h3><div class="tiny muted">No HR record. Contact admin.</div>`; mainContent.appendChild(card); return; } card.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div style="width:84px;height:84px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b1220">${emp.name.slice(0,2).toUpperCase()}</div><div><h3 style="margin:0">${emp.name}</h3><div class="tiny">${emp.role}</div></div></div><div style="height:12px"></div>`; if(emp.photo) card.innerHTML += `<div style="margin-bottom:10px"><img src="${emp.photo}" style="max-width:160px;border-radius:8px;"/></div>`; card.innerHTML += `<div class="tiny"><strong>Email:</strong> ${emp.email||'‚Äî'}</div><div style="height:8px"></div><div class="tiny"><strong>Bio:</strong><div style="margin-top:6px">${emp.bio || '<span class="tiny muted">No bio</span>'}</div></div>`; mainContent.appendChild(card); }

function renderMyOtherDetails(){ currentView='myOtherDetails'; pageTitle.textContent='Other Details'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const empId=getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId); const card=document.createElement('div'); card.className='card'; if(!emp){ card.innerHTML=`<h3 style="margin-top:0">Other Details</h3><div class="tiny muted">No HR record. Contact admin.</div>`; mainContent.appendChild(card); return; } card.innerHTML=`<h3 style="margin-top:0">Other Details</h3><div style="display:grid;gap:12px;margin-top:12px"><div class="tiny"><strong>Employee ID:</strong> ${emp.id||'‚Äî'}</div><div class="tiny"><strong>Joined Date:</strong> ${emp.joined||'‚Äî'}</div><div class="tiny"><strong>Base Salary:</strong> ${DATA.settings.currency}${emp.baseSalary||0}</div></div>`; mainContent.appendChild(card); }

function renderMyHrTools(){ currentView='myHrTools'; pageTitle.textContent='HR Tools'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 style="margin-top:0">HR Tools</h3><div style="display:grid;gap:12px;margin-top:12px"><div class="tiny">Employee self-service tools and resources.</div><button class="btn ghost" onclick="alert('Feature coming soon')">Download Payslip</button><button class="btn ghost" onclick="alert('Feature coming soon')">Update Contact Info</button><button class="btn ghost" onclick="alert('Feature coming soon')">View Policies</button></div>`; mainContent.appendChild(card); }

function renderMySalary(){ currentView='mySalary'; pageTitle.textContent='My Salary Details'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const empId=getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId); const payslips = DATA.payslips ? DATA.payslips.filter(p=>p.employeeId===empId).slice().reverse().slice(0,12) : []; const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 style="margin-top:0">Salary Details</h3>`; if(emp){ card.innerHTML += `<div style="margin-top:12px;padding:12px;background:rgba(79,70,229,0.05);border-radius:8px"><div class="tiny"><strong>Base Salary:</strong> ${DATA.settings.currency}${emp.baseSalary||0}</div></div>`; } if(payslips.length > 0){ const table=document.createElement('table'); table.className='table'; table.style.marginTop='12px'; table.innerHTML='<thead><tr><th>Month</th><th>Year</th><th>Gross</th><th>Deduction</th><th>Net</th></tr></thead>'; const tbody=document.createElement('tbody'); payslips.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.month}</td><td>${p.year}</td><td>${DATA.settings.currency}${p.gross}</td><td>${DATA.settings.currency}${p.deduction}</td><td><strong>${DATA.settings.currency}${p.net}</strong></td>`; tbody.appendChild(tr); }); table.appendChild(tbody); card.appendChild(table); } else { card.innerHTML += `<div class="tiny" style="margin-top:12px;color:var(--muted)">No payslips available yet.</div>`; } mainContent.appendChild(card); }

function renderMyTax(){ currentView='myTax'; pageTitle.textContent='My Tax Details'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const empId=getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId); const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 style="margin-top:0">Tax Details</h3><div style="display:grid;gap:12px;margin-top:12px"><div class="tiny"><strong>PAN:</strong> ${emp && emp.pan ? emp.pan : '‚Äî'}</div><div class="tiny"><strong>Aadhaar:</strong> ${emp && emp.aadhaar ? emp.aadhaar : '‚Äî'}</div><div class="tiny"><strong>Tax Category:</strong> ${emp && emp.taxCategory ? emp.taxCategory : '‚Äî'}</div><div class="tiny" style="margin-top:8px;color:var(--muted)">Contact HR for tax-related queries and updates.</div></div>`; mainContent.appendChild(card); }

function renderMyLeaveReport(){ currentView='myLeaveReport'; pageTitle.textContent='My Leave Report'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const empId=getEmployeeIdFromUser(APP.currentUser); const myLeaves = DATA.leaves ? DATA.leaves.filter(l=>l.employeeId===empId).slice().reverse() : []; const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 style="margin-top:0">My Leave History</h3>`; if(myLeaves.length > 0){ const table=document.createElement('table'); table.className='table'; table.style.marginTop='12px'; table.innerHTML='<thead><tr><th>Type</th><th>From</th><th>To</th><th>Days</th><th>Status</th></tr></thead>'; const tbody=document.createElement('tbody'); myLeaves.forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.type}</td><td>${l.from}</td><td>${l.to}</td><td>${l.days}</td><td>${l.status}</td>`; tbody.appendChild(tr); }); table.appendChild(tbody); card.appendChild(table); } else { card.innerHTML += `<div class="tiny" style="margin-top:12px;color:var(--muted)">No leave records found.</div>`; } mainContent.appendChild(card); }

/* Leave apply (employee) */
function renderLeaveApply(){ currentView='leaveApply'; pageTitle.textContent='Apply Leave'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const panel=document.createElement('div'); panel.className='card'; panel.innerHTML = '<h3 style="margin-top:0">Apply for Leave</h3>'; const form=document.createElement('div'); form.style.display='grid'; form.style.gap='8px'; const type=document.createElement('select'); type.className='input'; ['Annual','Sick','Casual','Other'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; type.appendChild(o); }); const from=document.createElement('input'); from.type='date'; from.className='input'; const to=document.createElement('input'); to.type='date'; to.className='input'; const reason=document.createElement('textarea'); reason.className='input'; reason.rows=3; const submit=document.createElement('button'); submit.className='btn primary'; submit.textContent='Apply'; submit.onclick = ()=>{ if(!from.value||!to.value) return alert('Pick dates'); const empId=getEmployeeIdFromUser(APP.currentUser); const emp = DATA.employees.find(e=>e.id===empId)||{name:APP.currentUser.displayName}; const days=Math.round((new Date(to.value)-new Date(from.value))/86400000)+1; const rec={id:'l'+Date.now(),employeeId:empId,name:emp.name,type:type.value,from:from.value,to:to.value,days,reason:reason.value,status:'Pending',appliedOn:new Date().toISOString()}; DATA.leaves.push(rec); saveData(); pushNotification({title:'Leave applied', message:`${emp.name} applied leave ${from.value}‚Üí${to.value}`, level:'info', targetRoles:['superadmin','admin','hr']}); alert('Leave applied'); if(isAdminOrHr()) renderAttendanceManagement(); else renderEmployeeHome(); refreshRecent(); }; form.appendChild(type); form.appendChild(from); form.appendChild(to); form.appendChild(reason); form.appendChild(submit); panel.appendChild(form); mainContent.appendChild(panel); }

/* ---------- Employee Management (admin) changes:
   - If employee already has a login, do NOT show Create Login button.
   - Only show Edit and Delete.
*/
function renderEmployeeManagement(){ currentView='employeeManagement'; if(!isAdminOrHr()) return accessDenied(); pageTitle.textContent='Employee Management'; pageSubtitle.textContent='Create employee records & login accounts'; mainContent.innerHTML=''; const panel=document.createElement('div'); panel.className='card'; panel.innerHTML = '<h3 style="margin-top:0">Employees</h3>'; const actionRow=document.createElement('div'); actionRow.style.display='flex'; actionRow.style.justifyContent='space-between'; actionRow.style.marginTop='10px'; const left=document.createElement('div'); const addBtn=document.createElement('button'); addBtn.className='btn primary'; addBtn.textContent='Add Employee'; addBtn.onclick = ()=>renderEmployeeAddForm(); left.appendChild(addBtn); actionRow.appendChild(left); const search=document.createElement('input'); search.className='input'; search.placeholder='Filter by name/email...'; search.style.width='320px'; search.oninput = ()=>renderEmployeeTable(panel, search.value.trim()); actionRow.appendChild(search); panel.appendChild(actionRow); renderEmployeeTable(panel, ''); mainContent.appendChild(panel); }

function renderEmployeeTable(container, filter){ const prev=container.querySelector('table'); if(prev) prev.remove(); const table=document.createElement('table'); table.className='table'; table.innerHTML='<thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Salary</th><th>Actions</th></tr></thead>'; const tbody=document.createElement('tbody'); if(!DATA || !DATA.employees) return; DATA.employees.filter(e=>{ if(!filter) return true; return (e.name && e.name.toLowerCase().includes(filter.toLowerCase())) || (e.email && e.email.toLowerCase().includes(filter.toLowerCase())); }).forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.name}</td><td>${e.email||''}</td><td>${e.role||''}</td><td>${e.joined||''}</td><td>${DATA.settings.currency}${e.baseSalary||0}</td><td></td>`; const td=tr.querySelector('td:last-child'); const edit=document.createElement('button'); edit.className='btn ghost'; edit.textContent='Edit'; edit.onclick = ()=>confirmAdminPasswordThen(()=>renderEmployeeEditForm(e.id)); td.appendChild(edit); const hasLogin = hasLoginForEmployee(e); if(!hasLogin){ const createLogin=document.createElement('button'); createLogin.className='btn primary'; createLogin.style.marginLeft='8px'; createLogin.textContent='Create Login'; createLogin.onclick = ()=>renderCreateLoginForEmployee(e.id); td.appendChild(createLogin); } else { // only show a small label that login exists
    const lbl = document.createElement('div'); lbl.className='tiny'; lbl.style.display='inline-block'; lbl.style.marginLeft='8px'; lbl.textContent='Login exists'; td.appendChild(lbl);
  } const del=document.createElement('button'); del.className='btn ghost'; del.style.marginLeft='8px'; del.textContent='Delete'; del.onclick = ()=>confirmAdminPasswordThen(()=>{ if(confirm('Delete employee & associated login?')){ DATA.employees = DATA.employees.filter(x=>x.id!==e.id); // remove any user with matching displayName or email prefix
    const uname = e.email ? e.email.split('@')[0] : null; if(uname) DATA.users = DATA.users.filter(u=>u.username !== uname); saveData(); renderEmployeeManagement(); } }); td.appendChild(del); tbody.appendChild(tr); }); table.appendChild(tbody); container.appendChild(table); }

/* helper to detect if employee has login (by displayName match or email prefix match) */
function hasLoginForEmployee(emp){
  if(!emp) return false;
  const byDisplay = DATA.users.find(u => (u.displayName && emp.name && u.displayName === emp.name));
  if(byDisplay) return true;
  if(emp.email){
    const prefix = emp.email.split('@')[0];
    const byPrefix = DATA.users.find(u => u.username === prefix);
    if(byPrefix) return true;
  }
  return false;
}

/* add employee (same as before) */
function renderEmployeeAddForm(){ currentView='employeeAdd'; pageTitle.textContent='Add Employee'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const panel=document.createElement('div'); panel.className='card'; panel.innerHTML='<h3 style="margin-top:0">Create Employee Record</h3>'; const form=document.createElement('div'); form.style.display='grid'; form.style.gap='8px'; const name=document.createElement('input'); name.className='input'; name.placeholder='Full name'; const email=document.createElement('input'); email.className='input'; email.placeholder='Email'; const role=document.createElement('input'); role.className='input'; role.placeholder='Role'; const salary=document.createElement('input'); salary.className='input'; salary.type='number'; salary.placeholder='Base salary'; const bio=document.createElement('textarea'); bio.className='input'; bio.rows=3; bio.placeholder='Short bio'; const photo=document.createElement('input'); photo.type='file'; photo.accept='image/*'; const submit=document.createElement('button'); submit.className='btn primary'; submit.textContent='Create Employee'; submit.onclick = async ()=>{ if(!name.value) return alert('Name required'); const id='e'+Date.now(); if(!DATA || !DATA.employees) DATA = await loadData(false); if(photo.files && photo.files[0]){ const r=new FileReader(); r.onload=async ()=>{ DATA.employees.push({id,name:name.value.trim(),email:email.value.trim(),role:role.value.trim()||'employee',joined:new Date().toISOString().split('T')[0],baseSalary:Number(salary.value||0),bio:bio.value||'',photo:r.result}); await saveData(true); // Wait for save DATA = await loadData(false); // Reload fresh data alert('Employee created'); renderEmployeeManagement(); }; r.readAsDataURL(photo.files[0]); } else { DATA.employees.push({id,name:name.value.trim(),email:email.value.trim(),role:role.value.trim()||'employee',joined:new Date().toISOString().split('T')[0],baseSalary:Number(salary.value||0),bio:bio.value||'',photo:null}); await saveData(true); // Wait for save DATA = await loadData(false); // Reload fresh data alert('Employee created'); renderEmployeeManagement(); } }; form.appendChild(name); form.appendChild(email); form.appendChild(role); form.appendChild(salary); form.appendChild(bio); form.appendChild(photo); form.appendChild(submit); panel.appendChild(form); mainContent.appendChild(panel); }

/* edit employee (admin confirmation) */
function renderEmployeeEditForm(empId){ currentView='employeeEdit'; if(!isAdminOrHr()) return accessDenied(); pageTitle.textContent='Edit Employee'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const emp = DATA.employees.find(e=>e.id===empId); if(!emp) return alert('Employee not found'); const panel=document.createElement('div'); panel.className='card'; panel.innerHTML = `<h3 style="margin-top:0">Edit ${emp.name}</h3>`; const form=document.createElement('div'); form.style.display='grid'; form.style.gap='8px'; const name=document.createElement('input'); name.className='input'; name.value = emp.name; const email=document.createElement('input'); email.className='input'; email.value = emp.email || ''; const role=document.createElement('input'); role.className='input'; role.value = emp.role || ''; const salary=document.createElement('input'); salary.className='input'; salary.type='number'; salary.value = emp.baseSalary || 0; const bio=document.createElement('textarea'); bio.className='input'; bio.rows=3; bio.value = emp.bio || ''; const photo=document.createElement('input'); photo.type='file'; photo.accept='image/*'; const saveBtn=document.createElement('button'); saveBtn.className='btn primary'; saveBtn.textContent='Save Changes'; saveBtn.onclick = ()=>confirmAdminPasswordThen(()=>{ emp.name = name.value.trim(); emp.email = email.value.trim(); emp.role = role.value.trim(); emp.baseSalary = Number(salary.value||0); emp.bio = bio.value; if(photo.files && photo.files[0]){ const r=new FileReader(); r.onload=()=>{ emp.photo = r.result; saveData(); alert('Saved'); renderEmployeeManagement(); }; r.readAsDataURL(photo.files[0]); } else { saveData(); alert('Saved'); renderEmployeeManagement(); } }); form.appendChild(name); form.appendChild(email); form.appendChild(role); form.appendChild(salary); form.appendChild(bio); form.appendChild(photo); form.appendChild(saveBtn); panel.appendChild(form); mainContent.appendChild(panel); }

/* create login for employee (only shown when hasLoginForEmployee returns false) */
function renderCreateLoginForEmployee(empId){ if(!isAdminOrHr()) return accessDenied(); const emp = DATA.employees.find(e=>e.id===empId); if(!emp) return alert('Employee not found'); currentView='createLogin'; pageTitle.textContent='Create Login'; pageSubtitle.textContent=`For ${emp.name}`; mainContent.innerHTML=''; const panel=document.createElement('div'); panel.className='card'; panel.innerHTML=`<h3 style="margin-top:0">Create login for ${emp.name}</h3>`; const form=document.createElement('div'); form.style.display='grid'; form.style.gap='8px'; const suggested = emp.email ? emp.email.split('@')[0] : emp.name.split(' ')[0].toLowerCase(); const username=document.createElement('input'); username.className='input'; username.value = suggested; username.placeholder='Username'; const pwd=document.createElement('input'); pwd.className='input'; pwd.type='password'; pwd.placeholder='Password'; const role=document.createElement('select'); role.className='input'; ['employee','hr','admin'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(emp.role===r) o.selected=true; role.appendChild(o); }); const submit=document.createElement('button'); submit.className='btn primary'; submit.textContent='Create Login Account'; submit.onclick = async ()=>{ const uname = username.value.trim(); const password = pwd.value; const r = role.value; if(!uname||!password) return alert('Provide username & password'); if(DATA.users.find(u=>u.username===uname)) return alert('Username exists'); const ph = await hashSHA256(password); DATA.users.push({id:'u_'+Date.now(), username:uname, passwordHash:ph, displayName:emp.name, role:r}); saveData(); alert('User account created. Provide credentials to employee.'); renderEmployeeManagement(); }; form.appendChild(username); form.appendChild(pwd); form.appendChild(role); form.appendChild(submit); panel.appendChild(form); mainContent.appendChild(panel); }

/* Attendance & Leave (admin) ‚Äî show only status, no action buttons */
function renderAttendanceManagement(){ currentView='attendanceManagement'; if(!isAdminOrHr()) return accessDenied(); pageTitle.textContent='Attendance & Leave'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.innerHTML = '<h3 style="margin-top:0">Attendance</h3>'; const table=document.createElement('table'); table.className='table'; table.innerHTML='<thead><tr><th>Name</th><th>Today</th></tr></thead>'; const tbody=document.createElement('tbody'); DATA.employees.forEach(e=>{ const key=e.id+'_'+todayKey(); const rec=DATA.attendance[key]; const tr=document.createElement('tr'); tr.innerHTML = `<td>${e.name}</td><td>${rec?rec.status + (rec.time ? ' ‚Äî '+rec.time : '') : '‚Äî'}</td>`; tbody.appendChild(tr); }); table.appendChild(tbody); card.appendChild(table); mainContent.appendChild(card); // Leaves card (unchanged)
  const leavesCard=document.createElement('div'); leavesCard.className='card'; leavesCard.style.marginTop='12px'; leavesCard.innerHTML = '<h3 style="margin-top:0">Leaves</h3>';
  if(DATA.leaves.length === 0) leavesCard.innerHTML += '<div class="tiny muted">No leaves</div>'; else { const lt=document.createElement('table'); lt.className='table'; lt.innerHTML='<thead><tr><th>Employee</th><th>From</th><th>To</th><th>Days</th><th>Status</th><th>Action</th></tr></thead>'; const lbody=document.createElement('tbody'); DATA.leaves.slice().reverse().forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.name}</td><td>${l.from}</td><td>${l.to}</td><td>${l.days}</td><td>${l.status}</td><td></td>`; const td=tr.querySelector('td:last-child'); if(l.status==='Pending'){ const appr=document.createElement('button'); appr.className='btn primary'; appr.textContent='Approve'; appr.onclick=()=>{ l.status='Approved'; saveData(); pushNotification({title:'Leave Approved', message:`${l.name}'s leave approved`, level:'success', targetRoles:['all']}); renderAttendanceManagement(); refreshRecent(); }; const rej=document.createElement('button'); rej.className='btn ghost'; rej.style.marginLeft='8px'; rej.textContent='Reject'; rej.onclick=()=>{ l.status='Rejected'; saveData(); pushNotification({title:'Leave Rejected', message:`${l.name}'s leave rejected`, level:'warn', targetRoles:['all']}); renderAttendanceManagement(); refreshRecent(); }; td.appendChild(appr); td.appendChild(rej); } lbody.appendChild(tr); }); lt.appendChild(lbody); leavesCard.appendChild(lt); }
  mainContent.appendChild(leavesCard); refreshRecent();
}

/* Employee marks present (one-time per day) */
function markPresentAndNotify(empId, name){ const key = empId+'_'+todayKey(); if(DATA.attendance[key]) return; DATA.attendance[key] = {employeeId:empId,name, date:todayKey(), status:'Present', time:new Date().toLocaleTimeString().slice(0,5)}; saveData(); pushNotification({title:'Marked Present', message:`${name} marked present.`, level:'success', targetRoles:['superadmin','admin','hr']}); if(APP.currentUser && APP.currentUser.role === 'employee') showToast({title:'Marked Present', message:'You have been marked present.', level:'success'}); if(isAdminOrHr()) renderAttendanceManagement(); else renderEmployeeHome(); refreshRecent(); }

/* small pages: payroll, reports, settings same as earlier (kept minimal) */
function renderPayroll(){ if(!isAdminOrHr()) return accessDenied(); currentView='payroll'; pageTitle.textContent='Payroll'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.innerHTML='<h3 style="margin-top:0">Payroll</h3>'; const month=document.createElement('input'); month.type='month'; month.className='input'; const run=document.createElement('button'); run.className='btn primary'; run.textContent='Run Payroll'; run.onclick = ()=>{ if(!month.value) return alert('Choose month'); const [y,m]=month.value.split('-'); DATA.employees.forEach(e=>{ const gross=Number(e.baseSalary||0); const deduction=Math.round(gross*0.10); const net=gross-deduction; DATA.payslips.push({id:'p'+Date.now()+Math.random().slice(2,6),employeeId:e.id,name:e.name,month:Number(m),year:Number(y),gross,deduction,net}); }); saveData(); alert('Payroll generated'); renderPayroll(); refreshRecent(); }; card.appendChild(month); card.appendChild(run); mainContent.appendChild(card); }
function renderReports(){ if(!isAdminOrHr()) return accessDenied(); currentView='reports'; pageTitle.textContent='Reports'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.innerHTML='<h3 style="margin-top:0">Reports</h3>'; const expA=document.createElement('button'); expA.className='btn ghost'; expA.textContent='Export Attendance CSV'; expA.onclick=()=>exportAttendanceCSV(); const expL=document.createElement('button'); expL.className='btn ghost'; expL.style.marginLeft='8px'; expL.textContent='Export Leaves CSV'; expL.onclick=()=>exportLeavesCSV(); card.appendChild(expA); card.appendChild(expL); mainContent.appendChild(card); }
function renderSettings(){ if(!isAdminOrHr()) return accessDenied(); currentView='settings'; pageTitle.textContent='Settings'; pageSubtitle.textContent=''; mainContent.innerHTML=''; const panel=document.createElement('div'); panel.className='card'; panel.innerHTML='<h3 style="margin-top:0">Settings</h3>'; const comp=document.createElement('input'); comp.className='input'; comp.value = DATA.settings.companyName; const cur=document.createElement('input'); cur.className='input'; cur.value = DATA.settings.currency; const ann=document.createElement('textarea'); ann.className='input'; ann.rows=4; ann.value = DATA.announcements || ''; const save=document.createElement('button'); save.className='btn primary'; save.textContent='Save'; save.onclick=()=>{ DATA.settings.companyName=comp.value; DATA.settings.currency=cur.value; DATA.announcements=ann.value; saveData(); alert('Saved'); refreshRecent(); }; panel.appendChild(document.createTextNode('Company name')); panel.appendChild(comp); panel.appendChild(document.createElement('div')); panel.appendChild(document.createTextNode('Currency')); panel.appendChild(cur); panel.appendChild(document.createElement('div')); panel.appendChild(document.createTextNode('Announcements')); panel.appendChild(ann); panel.appendChild(save); mainContent.appendChild(panel); }

/* utilities */
function makeTile(label,value){ const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<div class="label">${label}</div><div class="value">${value}</div>`; return t; }
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function getAttendanceForEmployee(empId,date=todayKey()){ return DATA.attendance[empId+'_'+date] || {}; }
function getEmployeeIdFromUser(user){ if(!user) return null; const byEmail = DATA.employees.find(e => e.email && user.username && e.email.split('@')[0] === user.username); if(byEmail) return byEmail.id; const prefix = user.displayName.split(' ')[0].toLowerCase(); const byName = DATA.employees.find(e => e.name && e.name.split(' ')[0].toLowerCase() === prefix); return byName ? byName.id : (DATA.employees.length ? DATA.employees[0].id : null); }
function accessDenied(){ mainContent.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML = '<h3 style="margin-top:0">Access denied</h3><div class="tiny muted">You do not have permission.</div>'; mainContent.appendChild(c); }
async function confirmAdminPasswordThen(callback){ const requireConfirm = true; if(!requireConfirm){ callback(); return; } const pwd = prompt('Enter your account password to confirm this action:'); if(pwd === null) return; const ph = await hashSHA256(pwd); if(!APP.currentUser || !APP.currentUser.passwordHash) return alert('No account info found.'); if(ph !== APP.currentUser.passwordHash) return alert('Password incorrect. Action canceled.'); callback(); }

/* create login helper used elsewhere (unchanged) */
async function createUserAccount(username,password,displayName,role='employee'){ 
  DATA = await loadData(); // Always reload fresh DATA before checking
  if(!DATA.users) DATA.users = [];
  if(DATA.users.find(u=>u.username===username)) throw new Error('username exists'); 
  const ph = await hashSHA256(password); 
  const u = {id:'u_'+Date.now(), username, passwordHash:ph, displayName, role}; 
  DATA.users.push(u); 
  await saveData(); 
  DATA = await loadData(); // Reload after save to ensure sync
  return u; 
}

/* export utils */
function downloadCSV(rows, filename){ const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function exportEmployeesCSV(){ const rows=[['id','name','email','role','joined','baseSalary','bio']]; DATA.employees.forEach(e=>rows.push([e.id,e.name,e.email||'',e.role||'',e.joined||'',e.baseSalary||0,e.bio||''])); downloadCSV(rows,'employees.csv'); }
function exportAttendanceCSV(){ const rows=[['employeeId','name','date','status','time']]; Object.values(DATA.attendance).forEach(a=>rows.push([a.employeeId,a.name,a.date,a.status,a.time||''])); downloadCSV(rows,'attendance.csv'); }
function exportLeavesCSV(){ const rows=[['id','employeeId','name','type','from','to','days','status','appliedOn']]; DATA.leaves.forEach(l=>rows.push([l.id,l.employeeId,l.name,l.type,l.from,l.to,l.days,l.status,l.appliedOn])); downloadCSV(rows,'leaves.csv'); }

/* recent */
function refreshRecent(){ recentWrap.innerHTML=''; annText.textContent = DATA.announcements || 'No announcements'; const att = Object.values(DATA.attendance).slice().reverse().slice(0,6).map(a=>({t:'Attendance',txt:`${a.name} ‚Äî ${a.status} ${a.time||''}`})); const leaves = DATA.leaves.slice().reverse().slice(0,6).map(l=>({t:'Leave',txt:`${l.name} ‚Äî ${l.type} (${l.status})`})); const pays = DATA.payslips.slice().reverse().slice(0,4).map(p=>({t:'Payslip',txt:`${p.name} ‚Äî ${DATA.settings.currency}${p.net}`})); const items = att.concat(leaves).concat(pays).slice(0,8); items.forEach(it=>{ const c=document.createElement('div'); c.style.minWidth='220px'; c.style.padding='12px'; c.style.borderRadius='12px'; c.style.background='linear-gradient(180deg,#fff,#fbfdff)'; c.style.border='1px solid rgba(11,18,32,0.03)'; c.innerHTML = `<div style="font-weight:700">${it.t}</div><div class="tiny" style="margin-top:8px;color:var(--muted)">${it.txt}</div>`; recentWrap.appendChild(c); }); }

/* show pending notifications when login or external update */
function showPendingNotificationsForCurrentUser(){ if(!APP.currentUser || !DATA.notifications) return; const recent = DATA.notifications.slice().reverse().filter(n=>matchesCurrentUserRole(n.targetRoles)).slice(0,5); recent.forEach(n=>showToast(n)); }

/* mark present called by employee button */
function markPresentAndNotify(empId, name){ const key = empId+'_'+todayKey(); if(DATA.attendance[key]) return; DATA.attendance[key] = {employeeId:empId,name,date:todayKey(),status:'Present',time:new Date().toLocaleTimeString().slice(0,5)}; saveData(); pushNotification({title:'Marked Present', message:`${name} marked present.`, level:'success', targetRoles:['superadmin','admin','hr']}); if(APP.currentUser && APP.currentUser.role === 'employee') showToast({title:'Marked Present', message:'You have been marked present.', level:'success'}); if(isAdminOrHr()) renderAttendanceManagement(); else renderEmployeeHome(); refreshRecent(); }

/* sign out */
sideSignOut.onclick = ()=>{ if(confirm('Sign out?')){ APP.currentUser = null; app.style.display='none'; loginWrap.style.display='flex'; loginUser.value=''; loginPass.value=''; } };
exportCSVs.onclick = ()=>{ exportEmployeesCSV(); exportAttendanceCSV(); exportLeavesCSV(); alert('Exported CSVs'); };
if(exportAll) exportAll.onclick = ()=>exportEmployeesCSV();

/* Helper function to quickly create test accounts */
async function createTestAccount(username = 'admin', password = 'admin123', displayName = 'Admin User', role = 'admin') {
  try {
    const user = await createUserAccount(username, password, displayName, role);
    console.log(`‚úÖ Account created successfully!`);
    console.log(`Username: ${username}`);
    console.log(`Password: ${password}`);
    console.log(`Role: ${role}`);
    console.log(`Display Name: ${displayName}`);
    return user;
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    return null;
  }
}

/* Helper to check and list all accounts */
async function checkAccounts(){
  DATA = await loadData();
  console.log('üìä Current accounts in system:');
  if(!DATA.users || DATA.users.length === 0){
    console.log('‚ùå No accounts found!');
    console.log('üí° Run: await MAFS.createDefaultAccounts() to create default accounts');
    return;
  }
  DATA.users.forEach((u, i) => {
    console.log(`${i+1}. Username: ${u.username}`);
    console.log(`   Role: ${u.role}`);
    console.log(`   Display Name: ${u.displayName}`);
  });
}

/* expose for debugging */
window.MAFS = { 
  DATA, 
  saveData, 
  createUserAccount,
  createTestAccount,
  createDefaultAccounts,
  checkAccounts,
  // Quick helpers
  createAdmin: async (username, password, displayName) => await createTestAccount(username, password, displayName, 'admin'),
  createSuperAdmin: async (username, password, displayName) => await createTestAccount(username, password, displayName, 'superadmin'),
  createEmployee: async (username, password, displayName) => await createTestAccount(username, password, displayName, 'employee')
};

/* initial UI remains driven by first-run and login handlers above */
</script>
</body>
</html>
